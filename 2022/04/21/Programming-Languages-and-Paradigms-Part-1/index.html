<!DOCTYPE html>


<html lang="zh-CN,en,default">
  

    <head>
      <meta charset="utf-8" />
        
      <meta name="description" content="share everything I want to share" />
      
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title>Programming Languages and Paradigms -- Part 1 |  Yangyang</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/favicon2.ico" />
       
<link rel="stylesheet" href="/dist/main.css">

      
<link rel="stylesheet" href="/css/fonts/remixicon.css">

      
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="https://cdn.staticfile.org/pace/1.2.4/pace.min.js"></script>
       
 

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bulma@5.0.1/bulma.min.css"
      />
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style>
    </head>
  </html>
</html>


<body>
  <div id="app">
    
      
    <main class="content on">
      <section class="outer">
  <article
  id="post-Programming-Languages-and-Paradigms-Part-1"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  Programming Languages and Paradigms -- Part 1
</h1>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2022/04/21/Programming-Languages-and-Paradigms-Part-1/" class="article-date">
  <time datetime="2022-04-21T17:15:41.000Z" itemprop="datePublished">2022-04-21</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/Coding/">Coding</a>
  </div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <p>A programming paradigm is a fundamental style of programming used to classify programming languages.</p>
<a id="more"></a>
<h1 id="Main-Programming-Paradigms-and-Sub-Paradigms"><a href="#Main-Programming-Paradigms-and-Sub-Paradigms" class="headerlink" title="Main Programming Paradigms and Sub-Paradigms"></a>Main Programming Paradigms and Sub-Paradigms</h1><h2 id="Imperative"><a href="#Imperative" class="headerlink" title="Imperative"></a>Imperative</h2><ul>
<li><p><em>Structured</em> (or procedural)</p>
<ul>
<li>Eg. C</li>
</ul>
</li>
<li><p><em>Object Oriented</em></p>
<ul>
<li>Encapsulation of code and the associated data into objects</li>
<li>Suit to problems of huge amounts of state/operations <ul>
<li>GUI, simulators, video games, business management software</li>
</ul>
</li>
<li>Easy to organize large codebases</li>
<li>Eg. C#, C++, Java, Python</li>
</ul>
</li>
<li><p><em>Concurrent</em></p>
<ul>
<li>Shared-memory threads/processes in C/C++, Java, Python, etc.</li>
<li>Message passing (for example MPI) in C/C++/FORTRAN</li>
<li>Semi-automatic loop paralelization with libraries such as OpenMP</li>
<li>GPU programming with CUDA</li>
<li>Use cases: HPC, distributed computing, graphic processing, etc.</li>
</ul>
</li>
<li><p>Describes <em>sequences</em> of statements manipulating the program state</p>
<ul>
<li>describes how to obtain the computation results </li>
</ul>
</li>
<li><p>Uses advanced control flow operations</p>
<ul>
<li>Loops, conditionals, procedures</li>
<li>easier to describe/reason about complex/large programs</li>
</ul>
</li>
<li><p>Uses execution threads/processes to describe interleaving and/or parallel computation flows</p>
<ul>
<li>Example in C:<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> *<span class="title">thread_function</span><span class="params">(<span class="keyword">void</span> *argument)</span> </span>&#123;     </span><br><span class="line">    <span class="keyword">int</span> id = *(<span class="keyword">int</span> *)argument;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">10</span>; i++)         </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Thread %d running on core %d\n&quot;</span>, id, sched_getcpu()); &#125; </span><br></pre></td></tr></table></figure>
<h2 id="Declarative"><a href="#Declarative" class="headerlink" title="Declarative"></a>Declarative</h2></li>
</ul>
</li>
<li><p><em>Functional</em></p>
<ul>
<li>First-class/higher-order functions </li>
<li>Loops implemented with recursion </li>
<li>Pure functions have no side-effects </li>
<li>Languages: Haskell, Scala, F#, etc.</li>
</ul>
</li>
<li><p><em>Concurrent</em></p>
<ul>
<li>Less need for synchronization</li>
<li>Use cases: distributed applications, web services, etc.</li>
</ul>
</li>
<li><p>Describes the <em>meaning/result</em> of computations</p>
</li>
<li><p>High level of abstraction Code can easily become convoluted </p>
</li>
<li><p>Languages: HTML, SQL, XML, CSS, Latex (non-Turing complete) </p>
</li>
<li><p>Usage: document rendering, structured data storage and manipulation</p>
</li>
<li><p>Calling and composing functions to describes the program </p>
</li>
</ul>
<h2 id="Multi-Paradigm-Languages"><a href="#Multi-Paradigm-Languages" class="headerlink" title="Multi-Paradigm Languages"></a>Multi-Paradigm Languages</h2><ul>
<li>Haskell: purely functional and does not allow OO style </li>
<li>OCaml: mainly functional, allows OO and imperative constructs </li>
<li>C, C++: imperative but allow some functional idoms:</li>
<li>Many languages are multi-paradigm</li>
</ul>
<h1 id="Introduction-to-C"><a href="#Introduction-to-C" class="headerlink" title="Introduction to C"></a>Introduction to C</h1><h2 id="Pros"><a href="#Pros" class="headerlink" title="Pros:"></a>Pros:</h2><ul>
<li>Syntax</li>
<li>Low level</li>
<li>Fast</li>
<li>Controlled memory footprint (occupation)控制内存占用<h2 id="Cons"><a href="#Cons" class="headerlink" title="Cons:"></a>Cons:</h2></li>
<li>Large area for making mistakes</li>
<li>Lack of memory safety, risks of undefined behavior at runtime<h2 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World"></a>Hello World</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt; // to get access to functions from external libraries</span></span></span><br><span class="line"><span class="comment">// will run first when the program is executed</span></span><br><span class="line"><span class="comment">// returns an integer and takes no parameters</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// print text on the standard output</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;hello, world!\n&quot;</span>);</span><br><span class="line">    <span class="comment">// return to go back to the calling context, and exit if returning from main</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
Assuming the code is in listing1.c, to compile and run on the linux command line:<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gcc listing1.c -o listing1</span><br><span class="line">.&#x2F;listing1</span><br><span class="line">hello, world! (This is the output)</span><br></pre></td></tr></table></figure>
<h1 id="C-–-Variables-Types-Printing-to-the-Console"><a href="#C-–-Variables-Types-Printing-to-the-Console" class="headerlink" title="C – Variables, Types, Printing to the Console"></a>C – Variables, Types, Printing to the Console</h1><h2 id="Variables"><a href="#Variables" class="headerlink" title="Variables:"></a>Variables:</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt; </span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a;                  <span class="comment">// declare a of type int (signed integer)     </span></span><br><span class="line">    a = <span class="number">12</span>;                 <span class="comment">// set the value of a to 12     </span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;a: %d\n&quot;</span>, a);   <span class="comment">// print the value of a</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>Variable:name,type,value</li>
<li>Must be <em>declared</em> before being used<ul>
<li>Declare with &lt;variable type&gt;&lt;variable name&gt;</li>
</ul>
</li>
<li>A variable’s name should start with a letter or underscore<ul>
<li>It can contain a combination of letters/numbers/underscores<ul>
<li>E.g: int _x; int sum; int combination_int3;<h2 id="Types"><a href="#Types" class="headerlink" title="Types:"></a>Types:</h2></li>
</ul>
</li>
</ul>
</li>
<li>Defines the amount of space in memory allocated to the variable </li>
<li>Compiler checks the validty of operations on the variable at build time</li>
<li>3 basic types categories: integers, floating-point numbers, characters<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// INTEGER</span></span><br><span class="line"><span class="keyword">int</span> a; <span class="comment">// signed integer takes 4 bytes in memory on the Intel x86-64 architecture</span></span><br><span class="line"><span class="comment">// CHARACTERS</span></span><br><span class="line"><span class="keyword">char</span> my_char_variable;</span><br><span class="line">my_char_variable = <span class="string">&#x27;x&#x27;</span>; <span class="comment">// using single quotes for characters</span></span><br><span class="line"><span class="comment">// FLOATS</span></span><br><span class="line"><span class="keyword">float</span> my_float_var;</span><br><span class="line">my_float_var = <span class="number">12.4</span>;</span><br><span class="line"><span class="comment">// MIXING INTEGERS AND FLOATS</span></span><br><span class="line"><span class="keyword">int</span> int1 = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">float</span> float1 = <span class="number">3.8</span>;</span><br><span class="line"><span class="keyword">int</span> int2 = int1 + float1; <span class="comment">// int2 = 5;</span></span><br><span class="line"><span class="keyword">int</span> int3 = int1 * float1; <span class="comment">// int3 = 7;</span></span><br><span class="line"><span class="comment">/* when mixed with floats in arithmetics, integers are promoted to floats */</span> </span><br><span class="line"><span class="comment">/* when stored in an integer variable, floats are _truncated_ */</span> </span><br></pre></td></tr></table></figure></li>
<li>Types and Qualifiers<ul>
<li>Types: char, int, float, double<ul>
<li>The function <code>sizeof</code> can be used to get the exact size of a type on a given manchine<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> so_short = <span class="keyword">sizeof</span>(<span class="keyword">short</span> <span class="keyword">int</span>);     </span><br><span class="line"><span class="keyword">int</span> so_int = <span class="keyword">sizeof</span>(<span class="keyword">int</span>); </span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;size of short:%d bytes\n&quot;</span>, so_short); </span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>Qualifers: signed, unsigned(positive), short, long</li>
<li>Determines the storage size in memory</li>
<li>Exact implementation is architecture dependent 依赖于架构<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">short</span> <span class="keyword">int</span> a;              <span class="comment">// signed, at least 16 bits: [−32,767,        +32,767] i</span></span><br><span class="line"><span class="keyword">int</span> b;                    <span class="comment">// signed, at least 16 bits: [−32,767,        +32,767] </span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> c;           <span class="comment">// unsigned:                 [0,              +65,535] </span></span><br><span class="line"><span class="keyword">long</span> <span class="keyword">int</span> d;               <span class="comment">// at least 32 bits:         [−2,147,483,647, +2,147,483,647] </span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> e;      <span class="comment">// unsigned:                 [0,              +4,294,967,295] </span></span><br><span class="line"><span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> f;          <span class="comment">// at least 64 bits:         [-9x10^18,       +9x10^18] </span></span><br><span class="line"><span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> g; <span class="comment">// unsigned:                 [0,              +18x10^18] </span></span><br><span class="line"><span class="keyword">float</span> h;                  <span class="comment">// storage size unspecified, generally 32 bits </span></span><br><span class="line"><span class="keyword">double</span> i;                 <span class="comment">// storage size unspecified, generally 64 bits</span></span><br></pre></td></tr></table></figure>
<h2 id="Printing-to-the-Console-printf"><a href="#Printing-to-the-Console-printf" class="headerlink" title="Printing to the Console: printf"></a>Printing to the Console: printf</h2></li>
</ul>
</li>
<li>Accepts one or more arguments: format string + variable list<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> int_var = <span class="number">-1</span>; </span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> uint_var = <span class="number">12</span>;</span><br><span class="line"><span class="keyword">long</span> <span class="keyword">int</span> lint_var = <span class="number">10</span>; </span><br><span class="line"><span class="keyword">float</span> float_var = <span class="number">2.5</span>; </span><br><span class="line"><span class="keyword">double</span> double_var = <span class="number">2.5</span>; </span><br><span class="line"><span class="keyword">char</span> char_var = <span class="string">&#x27;a&#x27;</span>; </span><br><span class="line"><span class="keyword">char</span> string_var[] = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Integer: %d\n&quot;</span>, int_var);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Unsigned integer: %u\n&quot;</span>, uint_var);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Long integer: %ld\n&quot;</span>, lint_var);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Float: %f\n&quot;</span>, float_var); </span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Double: %lf\n&quot;</span>, double_var); </span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Characters: %c\n&quot;</span>, char_var); </span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;String: %s\n&quot;</span>, string_var);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Several variables: %d, %lf, %s\n&quot;</span>,     int_var, double_var, string_var); </span><br><span class="line"><span class="comment">// Format string accepts escaped character such as \n for line break</span></span><br></pre></td></tr></table></figure></li>
<li>Make sure to use the right marker because the compiler won’t tell you the mistakes and incorrect values<ul>
<li>It will show warning like:”format ‘%u’ expects argument of type ‘unsigned int’, but argument 2 has type ‘long long unsigned int’ “<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> my_variable = <span class="number">-42</span>; </span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;-42 printed with %%d: %d\n&quot;</span>, my_variable); </span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;-42 printed with %%u: %u\n&quot;</span>, my_variable);  <span class="comment">// -42 interpreted as an unsigned integer</span></span><br><span class="line"><span class="comment">// The outcome is 4294967254</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> ull = <span class="number">5467513055454315</span>; </span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;ull printed with %%llu: %llu\n&quot;</span>, ull); </span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;ull printed with %%u: %u\n&quot;</span>, ull); <span class="comment">// interprets only 4 bytes vs. 8 for llu</span></span><br><span class="line"><span class="comment">// The outcome is 2507777131</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;ull printed with %%d: %d\n&quot;</span>, ull); <span class="comment">// first 4 bytes, interpreted as unsigned </span></span><br><span class="line"><span class="comment">// The outcome is -1787190165</span></span><br></pre></td></tr></table></figure>
<h1 id="Arrays-Strings-Command-Line-Arguments"><a href="#Arrays-Strings-Command-Line-Arguments" class="headerlink" title="Arrays, Strings, Command Line Arguments"></a>Arrays, Strings, Command Line Arguments</h1><h2 id="Arrays"><a href="#Arrays" class="headerlink" title="Arrays"></a>Arrays</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> <span class="built_in">array</span>[<span class="number">4</span>];     <span class="comment">// declaration </span></span><br><span class="line"><span class="built_in">array</span>[<span class="number">0</span>] = <span class="number">10</span>;    <span class="comment">// write a slot </span></span><br><span class="line"><span class="built_in">array</span>[<span class="number">1</span>] = <span class="number">20</span>; </span><br><span class="line"><span class="built_in">array</span>[<span class="number">2</span>] = <span class="number">30</span>; </span><br><span class="line"><span class="built_in">array</span>[<span class="number">3</span>] = <span class="number">40</span>;</span><br><span class="line"><span class="keyword">int</span> x = <span class="built_in">array</span>[<span class="number">3</span>];  <span class="comment">// read a slot</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;array[%d] contains %d\n&quot;</span>, <span class="number">0</span>, <span class="built_in">array</span>[<span class="number">0</span>]); <span class="comment">//array[0] contains 10</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;array[%d] contains %d\n&quot;</span>, <span class="number">1</span>, <span class="built_in">array</span>[<span class="number">1</span>]); <span class="comment">//array[1] contains 20</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;array[%d] contains %d\n&quot;</span>, <span class="number">2</span>, <span class="built_in">array</span>[<span class="number">2</span>]); <span class="comment">//array[2] contains 30</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>Arrays are stored <em>contiguously</em> in memory;</li>
<li>Multi-Dimensional Arrays<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> my_2d_array[<span class="number">3</span>][<span class="number">2</span>]; </span><br><span class="line">my_2d_array[<span class="number">0</span>][<span class="number">0</span>] = <span class="number">0</span>; </span><br></pre></td></tr></table></figure></li>
<li>Static initialization allows to omit the size (of the first dimension)<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> <span class="built_in">array</span>[] = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;; <span class="comment">// do not have the size </span></span><br><span class="line"><span class="keyword">int</span> array_2d[][<span class="number">2</span>] = &#123;&#123;<span class="number">1</span>, <span class="number">2</span>&#125;, &#123;<span class="number">3</span>, <span class="number">4</span>&#125;, &#123;<span class="number">5</span>, <span class="number">6</span>&#125;&#125;;</span><br></pre></td></tr></table></figure></li>
<li>Character arrays, i.e. Strings<ul>
<li>String: array of characters that ends with the special <code>\0</code> end of string character marker<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> string1[<span class="number">6</span>] = <span class="string">&quot;hello&quot;</span>; </span><br><span class="line"><span class="keyword">char</span> string2[] = <span class="string">&quot;hello&quot;</span>; </span><br><span class="line"><span class="keyword">char</span> string3[<span class="number">6</span>];</span><br><span class="line">string3[<span class="number">0</span>] = <span class="string">&#x27;h&#x27;</span>;     </span><br><span class="line">string3[<span class="number">1</span>] = <span class="string">&#x27;e&#x27;</span>;     </span><br><span class="line">string3[<span class="number">2</span>] = <span class="string">&#x27;l&#x27;</span>;     </span><br><span class="line">string3[<span class="number">3</span>] = <span class="string">&#x27;l&#x27;</span>;     </span><br><span class="line">string3[<span class="number">4</span>] = <span class="string">&#x27;o&#x27;</span>;     </span><br><span class="line">string3[<span class="number">5</span>] = <span class="string">&#x27;\0&#x27;</span>; <span class="comment">// Important here</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, string1); <span class="comment">// hello</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, string2); <span class="comment">// hello</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, string3); <span class="comment">// hello</span></span><br></pre></td></tr></table></figure>
<h2 id="Command-Line-Arguments"><a href="#Command-Line-Arguments" class="headerlink" title="Command Line Arguments"></a>Command Line Arguments</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc test.c -o program</span><br></pre></td></tr></table></figure>
gcc is program; the rest are arguments</li>
</ul>
</li>
<li><code>main</code> parameters:<ul>
<li>argc (integer)</li>
<li>argv: array containing the command line arguments</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123; <span class="comment">// &#x27;char ** argv&#x27; means &#x27;char argv[][]&#x27;     </span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Number of command line arguments: %d\n&quot;</span>, argc);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// This is a bit dangerous...     </span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;argument 0: %s\n&quot;</span>, argv[<span class="number">0</span>]);     </span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;argument 1: %s\n&quot;</span>, argv[<span class="number">1</span>]);     </span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;argument 2: %s\n&quot;</span>, argv[<span class="number">2</span>]);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>If the command line input is: <code>./test one two three</code></li>
</ul>
<p>The output is:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Number of command line arguments: 4</span><br><span class="line">argument 0: .&#x2F;test</span><br><span class="line">argument 1: one</span><br><span class="line">argument 2: two</span><br></pre></td></tr></table></figure>
<ul>
<li>If the command line input is: <code>./test one</code></li>
</ul>
<p>The output is:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Number of command line arguments: 2</span><br><span class="line">argument 0: .&#x2F;test</span><br><span class="line">argument 1: one</span><br><span class="line">argument 2: (null)</span><br></pre></td></tr></table></figure>
<ul>
<li>If the command line input is: <code>./test</code></li>
</ul>
<p>The output is:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Number of command line arguments: 1</span><br><span class="line">argument 0: .&#x2F;test</span><br><span class="line">argument 1: (null)</span><br><span class="line">argument 2: LC_ALL&#x3D;C.UTF-8</span><br></pre></td></tr></table></figure>
<p>This is quite DANGEROUS</p>
<ul>
<li>Arguments are strings, to convert to integer use <code>atoi</code>:<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt; </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt; // needed for atoi </span></span></span><br><span class="line"><span class="comment">/* Sum the two integers passed as command line integers */</span> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;     </span><br><span class="line">  <span class="keyword">int</span> a, b;     </span><br><span class="line">  <span class="comment">// Once again, dangerous!    </span></span><br><span class="line">  a = atoi(argv[<span class="number">1</span>]);     </span><br><span class="line">  b = atoi(argv[<span class="number">2</span>]);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%d + %d = %d\n&quot;</span>, a, b, a+b);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>To convert to a floating-point number (type double) use <code>atof</code><h1 id="Conditionals-and-Loops-in-C"><a href="#Conditionals-and-Loops-in-C" class="headerlink" title="Conditionals and Loops in C"></a>Conditionals and Loops in C</h1></li>
</ul>
</li>
<li>Statements end with <code>;</code> and are executed sequentially<h2 id="Conditionals"><a href="#Conditionals" class="headerlink" title="Conditionals"></a>Conditionals</h2></li>
<li>Condition: <code>&lt;</code>, <code>&lt;=</code>, <code>&gt;</code>, <code>&gt;=</code>, <code>==</code>，<code>!=</code></li>
<li>“false” is <code>0</code>, “true” is everything except <code>0</code></li>
<li>Boolean operations:<code>&amp;&amp;</code> AND, <code>||</code> OR, <code>!</code> negation<ul>
<li>Operators precedence优先级: <code>!</code>first, then<code>&amp;&amp;</code>, the<code>||</code></li>
<li>Use parentheses to modify/clarify evaluation order</li>
</ul>
</li>
<li>Switch statement<ul>
<li>Test the equality of an integer against a list of values</li>
<li>Use <code>break</code> to avoid fallthrough坠落 in cases</li>
<li><code>default</code> path taken when none of the other cases matches<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span>(x) &#123;     </span><br><span class="line">  <span class="keyword">case</span> <span class="number">1</span>:         </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;x is 1\n&quot;</span>);         </span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">2</span>:         </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;x is 2\n&quot;</span>);         </span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">3</span>:         </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;x is 3\n&quot;</span>);         </span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">default</span>:         </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;x is neither 1, nor 2, nor 3\n&quot;</span>); &#125;</span><br></pre></td></tr></table></figure>
<h2 id="Loops"><a href="#Loops" class="headerlink" title="Loops"></a>Loops</h2></li>
</ul>
</li>
<li>While loop<ul>
<li><code>while...</code> checks the condition before entering the loop body</li>
<li><code>do... while</code> checks after a first iteration</li>
</ul>
</li>
<li>For Loops<ul>
<li>for (&lt;init statement&gt; ; &lt;condition&gt;; &lt;update statement&gt;) {&lt;body&gt;}<ul>
<li>&lt;init statement&gt; executed once before the first iteration</li>
<li>&lt;condition&gt; checked before each iteration</li>
<li>&lt;update statement&gt; executed after each iteration</li>
<li>E.g <code>for(int i = 0; i&lt;10; i = i + 1) &#123;...&#125;</code></li>
</ul>
</li>
<li><code>break</code> simply exits the loop</li>
<li><code>continue</code> directly goes to the next iteration<h2 id="Back-to-fix-command-line-potential-danger"><a href="#Back-to-fix-command-line-potential-danger" class="headerlink" title="Back to fix command line potential danger"></a>Back to fix command line potential danger</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">print_help_and_exit</span><span class="params">(<span class="keyword">char</span> **argv)</span> </span>&#123;     </span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Usage: %s &lt;number 1&gt; &lt;number 2&gt;\n&quot;</span>, argv[<span class="number">0</span>]);     </span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">-1</span>); &#125; </span><br><span class="line">  <span class="comment">/* Sum the two integers passed as command line integers */</span> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;     </span><br><span class="line">  <span class="keyword">int</span> a, b;</span><br><span class="line">  <span class="comment">// To make sure there are only two numbers in command line</span></span><br><span class="line">  <span class="keyword">if</span>(argc != <span class="number">3</span>)         </span><br><span class="line">    print_help_and_exit(argv);     </span><br><span class="line">  a = atoi(argv[<span class="number">1</span>]);     </span><br><span class="line">  b = atoi(argv[<span class="number">2</span>]);     </span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%d + %d = %d\n&quot;</span>, a, b, a+b);     </span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>; &#125;</span><br></pre></td></tr></table></figure>
<h2 id="Braces-in-Conditional-and-Loops"><a href="#Braces-in-Conditional-and-Loops" class="headerlink" title="Braces in Conditional and Loops"></a>Braces in Conditional and Loops</h2></li>
</ul>
</li>
<li>Can omit(ignore) the braces if conditional/loop body is a single statement<h1 id="Functions"><a href="#Functions" class="headerlink" title="Functions"></a>Functions</h1></li>
<li>Contains <em>name</em>, zero or more <em>parameters</em> with <em>types</em>, and a <em>return type</em><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">add_two_integers</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;     </span><br><span class="line">  <span class="keyword">int</span> result = a + b;     </span><br><span class="line">  <span class="keyword">return</span> result; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>The absence缺席 of return value can be indicated with the <code>void</code> type<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_hello</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;     </span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;hello!\n&quot;</span>);     </span><br><span class="line">  <span class="keyword">return</span>; <span class="comment">// we can even omit this as the function does not return anything &#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="Function-Calls"><a href="#Function-Calls" class="headerlink" title="Function Calls"></a>Function Calls</h2></li>
<li>Function parameters and return value are passed as copies<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">my_function</span><span class="params">(<span class="keyword">int</span> parameter)</span> </span>&#123;     </span><br><span class="line">    parameter = <span class="number">12</span>; <span class="comment">// does not update x in main </span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;     </span><br><span class="line">    <span class="keyword">int</span> x = <span class="number">10</span>;     </span><br><span class="line">    my_function(x);     </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;x is %d\n&quot;</span>, x); <span class="comment">// x is 10</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Forward-Declarations"><a href="#Forward-Declarations" class="headerlink" title="Forward Declarations"></a>Forward Declarations</h2></li>
<li>Forward declaration, also called function _prototype_ 原型</li>
<li>The compiler parses解析 source files from top to bottom<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span>; </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  ....</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* The actual function definition */</span> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;     </span><br><span class="line">  <span class="keyword">return</span> a + b; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Variable-Scope-and-Lifetime"><a href="#Variable-Scope-and-Lifetime" class="headerlink" title="Variable Scope and Lifetime"></a>Variable Scope and Lifetime</h2></li>
<li>Global variables declared outside functions<ul>
<li>visible at the level of the entire source file</li>
</ul>
</li>
<li>Try to <em>limit</em> the use of globals as much as possible<ul>
<li>A lot of global state makes it harder to reason about the program</li>
</ul>
</li>
<li>Within a a function, a declared local variable is accesible within its enclosing braces (a block of code)<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> j; </span><br><span class="line"><span class="keyword">for</span>(j=<span class="number">0</span>; j&lt;<span class="number">10</span>; j++) &#123; </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;In loop body, j is %d\n&quot;</span>, j); </span><br><span class="line">&#125;   </span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Out of loop body, j is %d\n&quot;</span>, j); <span class="comment">// Out of loop body, j is 10</span></span><br></pre></td></tr></table></figure>
<h1 id="Custom-Types-and-Data-Structures-in-C"><a href="#Custom-Types-and-Data-Structures-in-C" class="headerlink" title="Custom Types and Data Structures in C"></a>Custom Types and Data Structures in C</h1><h2 id="Custom-Types"><a href="#Custom-Types" class="headerlink" title="Custom Types"></a>Custom Types</h2></li>
<li>Use <code>typedef</code> to alias别名 a type<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt; </span></span></span><br><span class="line"><span class="comment">// &#x27;my_int&#x27; is now equivalent to &#x27;long long unsigned int&#x27; </span></span><br><span class="line"><span class="comment">// To make it shorter</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> my_int;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;     </span><br><span class="line">  my_int x = <span class="number">12</span>;     </span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;x is: %llu\n&quot;</span>, x);    </span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Custom-Data-Structures"><a href="#Custom-Data-Structures" class="headerlink" title="Custom Data Structures"></a>Custom Data Structures</h2></li>
<li>Use struct to define a data structure with named fields </li>
<li>Use struct &lt;struct name&gt; to refer to it as a type </li>
<li>Access the fields of a variable with &lt;variable_name&gt;.&lt;field_name&gt;<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt; </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt; // needed for strcpy (string copy)</span></span></span><br><span class="line"><span class="comment">// Definition of the struct: </span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">person</span> &#123;</span>     </span><br><span class="line">  <span class="keyword">char</span> name[<span class="number">10</span>];     </span><br><span class="line">  <span class="keyword">float</span> size_in_meters;     </span><br><span class="line">  <span class="keyword">int</span> weight_in_grams; </span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_person</span><span class="params">(struct person p)</span> </span>&#123;</span><br><span class="line">  <span class="comment">/* Access fields with &#x27;.&#x27; */</span>     </span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%s has a size of %f meters and weights %d grams\n&quot;</span>, p.name, p.size_in_meters, p.weight_in_grams); </span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;     </span><br><span class="line">  <span class="comment">// declare a variable of the struct type:     </span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">person</span> <span class="title">p1</span>;</span>     </span><br><span class="line">  <span class="comment">// sets the variable field     </span></span><br><span class="line">  p1.size_in_meters = <span class="number">1.6</span>;     </span><br><span class="line">  p1.weight_in_grams = <span class="number">60000</span>;     </span><br><span class="line">  <span class="built_in">strcpy</span>(p1.name, <span class="string">&quot;Julie&quot;</span>);</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">person</span> <span class="title">p2</span> =</span> &#123;<span class="string">&quot;George&quot;</span>, <span class="number">1.8</span>, <span class="number">70000</span>&#125;;     </span><br><span class="line">  print_person(p1);     </span><br><span class="line">  print_person(p2);     </span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>Fields are place consecutively连续地 in memory (compiler may insert padding)</li>
<li>Structures can be <code>typedef</code><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt; </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt; // needed for strcpy</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">s_person</span> &#123;</span>     </span><br><span class="line">  <span class="comment">/* fields declaration ... */</span> </span><br><span class="line">&#125;; </span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">s_person</span> <span class="title">person</span>;</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_person</span><span class="params">(person p)</span> </span>&#123; <span class="comment">/* ... */</span>&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;     </span><br><span class="line">  person p1;     </span><br><span class="line">  person p2 = &#123;<span class="string">&quot;George&quot;</span>, <span class="number">1.8</span>, <span class="number">70000</span>&#125;;     </span><br><span class="line">  <span class="comment">/* ... */</span> &#125;</span><br></pre></td></tr></table></figure>
A faster way to define structures:<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="comment">/* fields declaration ... */</span></span><br><span class="line">&#125; person;</span><br></pre></td></tr></table></figure>
<h2 id="Enumeration"><a href="#Enumeration" class="headerlink" title="Enumeration"></a>Enumeration</h2></li>
<li>User defined type for assigning textual names to integer constants</li>
<li>The compiler assigns an <em>integer constant</em> to each value of an enum<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">color</span>&#123;</span></span><br><span class="line">  RED,</span><br><span class="line">  BLUE,</span><br><span class="line">  GREEN</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>Enumerations can be <code>typedef</code>‘d</li>
</ul>
<p><code>typedef enum color mycolor</code></p>
<p>or in once:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> &#123;</span>     </span><br><span class="line">  BLUE,     </span><br><span class="line">  <span class="comment">/* ... */</span> </span><br><span class="line">&#125; color;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="Introduction-to-Pointers"><a href="#Introduction-to-Pointers" class="headerlink" title="Introduction to Pointers"></a>Introduction to Pointers</h1><h2 id="Program-Memory-Layout"><a href="#Program-Memory-Layout" class="headerlink" title="Program Memory Layout"></a>Program Memory Layout</h2><ul>
<li>All the program’s code and data is present somewhere in memory </li>
<li>The area of memory accessible by the program is the <em>address space</em><ul>
<li>Large array of contiguous bytes</li>
<li>Addresses are indexes in that array</li>
</ul>
</li>
<li>This is <em>Virtual</em> memory:<ul>
<li>Address space size independent from the amount of RAM</li>
<li>Each program gets its own address space</li>
</ul>
</li>
<li><em>Address of a variable:</em> the address in memory of the first byte storing that variable</li>
<li>Use the <code>&amp;</code> operator to get the address of a variable</li>
<li>With modern processeors an address is a 64 bit value so we need the right format specifier: ‘%lu’ or ‘%lx’ if we want to print in hexadecimal<h2 id="Pointers"><a href="#Pointers" class="headerlink" title="Pointers"></a>Pointers</h2></li>
<li>Pointer: variable that contains an address(possibly of another variable)<ul>
<li>Declaration: &lt;pointed type&gt; * &lt;pointer name&gt;<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> v = <span class="number">42</span>; </span><br><span class="line"><span class="keyword">int</span> *ptr = &amp;v;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>Access the pointed value with <code>*</code><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;pointer value:   0x%lx\n&quot;</span>, ptr);  <span class="comment">// 0xF123</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;pointed value:   %d\n&quot;</span>, *ptr);    <span class="comment">// 42</span></span><br></pre></td></tr></table></figure>
<h1 id="Pointers-Applications"><a href="#Pointers-Applications" class="headerlink" title="Pointers Applications"></a>Pointers Applications</h1><h2 id="Allow-a-Function-to-Access-the-Calling-Context"><a href="#Allow-a-Function-to-Access-the-Calling-Context" class="headerlink" title="Allow a Function to Access the Calling Context"></a>Allow a Function to Access the Calling Context</h2></li>
<li>Can’t change a fuction’s parameter unless to use pointer<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add_one</span><span class="params">(<span class="keyword">int</span> *param)</span> </span>&#123;</span><br><span class="line">  *param++;  <span class="comment">// access the pointed value</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;     </span><br><span class="line">  <span class="keyword">int</span> x = <span class="number">20</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;before call, x is %d\n&quot;</span>, x);   <span class="comment">// print 20     </span></span><br><span class="line">  add_one(&amp;x);     <span class="comment">// address of x</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;after call, x is %d\n&quot;</span>, x);    <span class="comment">// print 21</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>A function can ‘return’ more than a single value if…<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// we want this function to return 3 things: the product and quotient of n1 by n2, </span></span><br><span class="line"><span class="comment">// as well as an error code in case division is impossible </span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">multiply_and_divide</span><span class="params">(<span class="keyword">int</span> n1, <span class="keyword">int</span> n2, <span class="keyword">int</span> *product, <span class="keyword">int</span> *quotient)</span> </span>&#123;     </span><br><span class="line">  <span class="comment">/* Can&#x27;t divide if n2 is 0 */</span>     </span><br><span class="line">  <span class="keyword">if</span>(n2 == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  *product = n1 * n2;     </span><br><span class="line">  *quotient = n1 / n2;     </span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">&#125; </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;     </span><br><span class="line">  <span class="keyword">int</span> p, q, a = <span class="number">10</span>, b = <span class="number">5</span>;     </span><br><span class="line">  <span class="keyword">if</span>(multiply_and_divide(a, b, &amp;p, &amp;q) == <span class="number">0</span>) &#123;         </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;10*5 = %d\n&quot;</span>, p); <span class="comment">// 10*5 = 50</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;10/5 = %d\n&quot;</span>, q); <span class="comment">// 10/5 = 2     </span></span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Getting-over-C-FUnction-Call-Limitations"><a href="#Getting-over-C-FUnction-Call-Limitations" class="headerlink" title="Getting over C FUnction Call Limitations"></a>Getting over C FUnction Call Limitations</h2></li>
<li>Assume we want to write a function updating a large struct variable<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="comment">// lots of large (8 bytes) fields:</span></span><br><span class="line">    <span class="keyword">double</span> a; <span class="keyword">double</span> b; <span class="keyword">double</span> c; <span class="keyword">double</span> d; <span class="keyword">double</span> e; <span class="keyword">double</span> f;</span><br><span class="line">&#125; large_struct;</span><br><span class="line"></span><br><span class="line"><span class="function">large_struct <span class="title">f</span><span class="params">(large_struct s)</span> </span>&#123; <span class="comment">// very inefficient in terms of performance and memory usage!</span></span><br><span class="line">    s.a += <span class="number">42.0</span>;</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;<span class="comment">//set a large struct and only change one variable in it</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    large_struct x = &#123;<span class="number">1.0</span>, <span class="number">2.0</span>, <span class="number">3.0</span>, <span class="number">4.0</span>, <span class="number">5.0</span>, <span class="number">6.0</span>&#125;;</span><br><span class="line">    large_struct y = f(x);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;y.a: %f\n&quot;</span>, y.a); <span class="comment">// 43.0000</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>Huge performance loss and memory footprint increase!</li>
<li>Solution: With pointer: maintain a single copy of the variable<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span> </span><br><span class="line">  <span class="keyword">double</span> a; <span class="keyword">double</span> b; <span class="keyword">double</span> c; <span class="keyword">double</span> d; <span class="keyword">double</span> e; <span class="keyword">double</span> f;</span><br><span class="line">&#125; large_struct;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">(large_struct *s)</span> </span>&#123;  <span class="comment">// now takes a pointer parameter</span></span><br><span class="line">    (*s).a += <span class="number">42.0</span>;         <span class="comment">// dereference to access x</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    large_struct x = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>&#125;;</span><br><span class="line">    f(&amp;x);                 <span class="comment">// pass x&#x27;s address</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;x.a: %f\n&quot;</span>, x.a);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
This is much faster and efficient<h2 id="C-Arrarys-are-Pointers"><a href="#C-Arrarys-are-Pointers" class="headerlink" title="C Arrarys are Pointers!"></a>C Arrarys are Pointers!</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">negate_int_array</span><span class="params">(<span class="keyword">int</span> *ptr, <span class="keyword">int</span> size)</span> </span>&#123; <span class="comment">// functions taking arrays as parameters</span></span><br><span class="line">  <span class="comment">// also need the size to iterate properly</span></span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;size; i++)     </span><br><span class="line">  <span class="comment">// use square brackets like a standard array</span></span><br><span class="line">    ptr[i] = -ptr[i];      </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> <span class="built_in">array</span>[] = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>&#125;;</span><br><span class="line">    negate_int_array(<span class="built_in">array</span>, <span class="number">7</span>); <span class="comment">// to get the pointer just use the array&#x27;s name</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">7</span>; i++)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;array[%d] = %d\n&quot;</span>, i, <span class="built_in">array</span>[i]); <span class="comment">// the result will be negative</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>We can call the elemnt in array by using *(arrayname + index)<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> int_array[<span class="number">2</span>] = &#123;<span class="number">1</span>, <span class="number">2</span>&#125;;</span><br><span class="line">    <span class="keyword">double</span> double_array[<span class="number">2</span>] = &#123;<span class="number">4.2</span>, <span class="number">2.4</span>&#125;;</span><br><span class="line">    <span class="keyword">char</span> char_array[] = <span class="string">&quot;ab&quot;</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;int_array[0]      = %d\n&quot;</span>, int_array[<span class="number">0</span>]); <span class="comment">//=1</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;int_array[1]      = %d\n&quot;</span>, int_array[<span class="number">1</span>]); <span class="comment">//=2</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;*(int_array+0)    = %d\n&quot;</span>, *(int_array+<span class="number">0</span>)); <span class="comment">// pointer arithmetic!, =1</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;*(int_array+1)    = %d\n&quot;</span>, *(int_array+<span class="number">1</span>)); <span class="comment">// +1 means + sizeof(array type), =2</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;double_array[0]   = %f\n&quot;</span>, double_array[<span class="number">0</span>]); <span class="comment">//=4.200</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;double_array[1]   = %f\n&quot;</span>, double_array[<span class="number">1</span>]); <span class="comment">//=2.400</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;*(double_array+0) = %f\n&quot;</span>, *(double_array+<span class="number">0</span>));<span class="comment">//=4.200</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;*(double_array+1) = %f\n&quot;</span>, *(double_array+<span class="number">1</span>));<span class="comment">//=2.400</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;char_array[0]     = %c\n&quot;</span>, char_array[<span class="number">0</span>]);    <span class="comment">//=a</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;char_array[1]     = %c\n&quot;</span>, char_array[<span class="number">1</span>]);    <span class="comment">//=b</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;*(char_array+0)   = %c\n&quot;</span>, *(char_array+<span class="number">0</span>));  <span class="comment">//=a</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;*(char_array+1)   = %c\n&quot;</span>, *(char_array+<span class="number">1</span>));  <span class="comment">//=b</span></span><br></pre></td></tr></table></figure>
<h2 id="Pointers-and-Structures"><a href="#Pointers-and-Structures" class="headerlink" title="Pointers and Structures"></a>Pointers and Structures</h2></li>
<li>. takes precedence优先级 over *</li>
<li>s-&gt;x is a shortcut for (*s).x<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> int_member1;</span><br><span class="line">    <span class="keyword">int</span> int_member2;</span><br><span class="line">    <span class="keyword">int</span> *ptr_member;</span><br><span class="line">&#125; my_struct;</span><br><span class="line"><span class="comment">/* declare and initialise ms of type my_struct ... */</span></span><br><span class="line">my_struct *p = &amp;ms;</span><br><span class="line">(*p).int_member1 = <span class="number">1</span>; <span class="comment">// don&#x27;t forget the parentheses! . takes precedence over *</span></span><br><span class="line">p-&gt;int_member2 = <span class="number">2</span>;   <span class="comment">// s-&gt;x is a shortcut for (*s).x</span></span><br><span class="line">p-&gt;ptr_member = &amp;(p-&gt;int_member2);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;p-&gt;int_member1 = %d\n&quot;</span>, p-&gt;int_member1); <span class="comment">//1</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;p-&gt;int_member2 = %d\n&quot;</span>, p-&gt;int_member2); <span class="comment">//2</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;p-&gt;ptr_member = %p\n&quot;</span>, p-&gt;ptr_member);   <span class="comment">//0x7fff38692954</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;*(p-&gt;ptr_member) = %d\n&quot;</span>, *(p-&gt;ptr_member)); <span class="comment">//2</span></span><br></pre></td></tr></table></figure>
p-&gt;int_member2 is (*p).int_member2 = 2; &amp;(p-&gt;int_member2) is the address of this variable; *(p-&gt;ptr_member) is the actual value of this address point at<h2 id="Pointer-Chains"><a href="#Pointer-Chains" class="headerlink" title="Pointer Chains"></a>Pointer Chains</h2></li>
<li>A pointer is a variable and has itself an address, i.e. a location in memory, so it can be pointed to!<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> value = <span class="number">42</span>;         <span class="comment">// integer</span></span><br><span class="line"><span class="keyword">int</span> *ptr1 = &amp;value;     <span class="comment">// pointer of integer</span></span><br><span class="line"><span class="keyword">int</span> **ptr2 = &amp;ptr1;     <span class="comment">// pointer of pointer of integer</span></span><br><span class="line"><span class="keyword">int</span> ***ptr3 = &amp;ptr2;    <span class="comment">// pointer of pointer of pointer of integer</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;ptr1: %p, *ptr1: %d\n&quot;</span>, ptr1, *ptr1);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;ptr2: %p, *ptr2: %p, **ptr2: %d\n&quot;</span>, ptr2, *ptr2, **ptr2);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;ptr3: %p, *ptr3: %p, **ptr3: %p, ***ptr3: %d\n&quot;</span>, ptr3, *ptr3, **ptr3, ***ptr3);</span><br></pre></td></tr></table></figure>
The output is:<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ptr1: 0x7ffc7e51775c, *ptr1: 42</span><br><span class="line">ptr2: 0x7ffc7e517760, *ptr2: 0x7ffc7e51775c, **ptr2: 42</span><br><span class="line">ptr3: 0x7ffc7e517768, *ptr3: 0x7ffc7e517760, **ptr3: 0x7ffc7e51775c, ***ptr3: 42</span><br></pre></td></tr></table></figure>
<h1 id="Dynamic-Memory-Allocation"><a href="#Dynamic-Memory-Allocation" class="headerlink" title="Dynamic Memory Allocation"></a>Dynamic Memory Allocation</h1><h2 id="Motivation"><a href="#Motivation" class="headerlink" title="Motivation"></a>Motivation</h2></li>
<li>Many scenarios where an array size is determined only at runtime</li>
<li>Variable size arrays are rarely used due to support and space restrictions<ul>
<li>Are not supported for all versions of C, if we try a very large number, we will get an error “segmentation fault”</li>
</ul>
</li>
<li>So we need another solution</li>
<li>Static data: large size, all allocations fixed at compile time. Store <em>global variables</em> </li>
<li>Stack: small size, most allocations fixed at compile time.</li>
<li>Heap: lagre size, all allocations made dynamically at runtime<h2 id="Allocating-on-the-Heap-malloc"><a href="#Allocating-on-the-Heap-malloc" class="headerlink" title="Allocating on the Heap: malloc"></a>Allocating on the Heap: <code>malloc</code></h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt; // needed for malloc</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">process_array</span><span class="params">(<span class="keyword">int</span> *<span class="built_in">array</span>, <span class="keyword">int</span> size)</span> </span>&#123; <span class="comment">/* do something with array */</span> &#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> *heap_array;</span><br><span class="line">  <span class="comment">/* ... */</span></span><br><span class="line">  <span class="keyword">int</span> size = atoi(argv[<span class="number">1</span>]);</span><br><span class="line">  heap_array = <span class="built_in">malloc</span>(size * <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">  <span class="keyword">if</span>(heap_array == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  process_array(heap_array, size);</span><br><span class="line">  <span class="built_in">free</span>(heap_array); <span class="comment">//free up memory when you done with it</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><code>malloc</code> allocates a chunk of memory on the heap and returns a pointer to it<ul>
<li>Memory is contiguous and can be used as an array</li>
</ul>
</li>
<li>Returns NULL (0) if the allocation fails<ul>
<li><em>Always check the return value</em></li>
</ul>
</li>
<li><code>void *</code>: generic pointer type<ul>
<li>Void pointer is a specific pointer type – void * – a pointer that points to some data location in storage, which doesn’t have any specific type. Void refers to the type. Basically the type of data that it points to is can be any. If we assign address of char data type to void pointer it will become char Pointer, if int data type then int pointer and so on. <a target="_blank" rel="noopener" href="https://www.atnyla.com/tutorial/void-generic-pointers/1/371#:~:text=When%20a%20variable%20is%20declared,another%20kind%20of%20pointer%20first.">Citation</a></li>
</ul>
</li>
<li><code>size_t</code>: long unsigned int<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">malloc</span><span class="params">(<span class="keyword">size_t</span> size)</span></span>; </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free</span><span class="params">(<span class="keyword">void</span> *ptr)</span></span>;</span><br></pre></td></tr></table></figure>
<h2 id="Multidimensional-Arrays-and-malloc"><a href="#Multidimensional-Arrays-and-malloc" class="headerlink" title="Multidimensional Arrays and malloc"></a>Multidimensional Arrays and malloc</h2></li>
<li>3 x 2 int array<br><img src="https://olivierpierre.github.io/comp26020/slides/11-dynamic-memory-allocation/include/2d-3.svg" alt="double array in heap and stack"></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> a = <span class="number">3</span>; <span class="keyword">int</span> b = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">int</span> **<span class="built_in">array</span>; </span><br><span class="line"><span class="built_in">array</span> = <span class="built_in">malloc</span>(a * <span class="keyword">sizeof</span>(<span class="keyword">int</span> *)); <span class="comment">// return the pointer of 1d array pointers</span></span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">array</span> == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;a; i++) &#123;</span><br><span class="line">    <span class="built_in">array</span>[i] = <span class="built_in">malloc</span>(b * <span class="keyword">sizeof</span>(<span class="keyword">int</span>)); <span class="comment">//return the pointer of numbers </span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">array</span>[i] == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">array</span>[<span class="number">2</span>][<span class="number">0</span>] = <span class="number">12</span>;</span><br><span class="line"><span class="comment">/* ... */</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;a; i++)</span><br><span class="line">    <span class="built_in">free</span>(<span class="built_in">array</span>[i]);</span><br><span class="line"><span class="built_in">free</span>(<span class="built_in">array</span>);</span><br></pre></td></tr></table></figure>
<h2 id="Memory-Leaks"><a href="#Memory-Leaks" class="headerlink" title="Memory Leaks"></a>Memory Leaks</h2><ul>
<li>Don’t forget to free memory!<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_ten_integers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> *<span class="built_in">array</span> = <span class="built_in">malloc</span>(<span class="number">10</span> * <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">array</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;cannot allocate memory ...\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">10</span>; i++) &#123;</span><br><span class="line">        <span class="built_in">array</span>[i] = rand()%<span class="number">100</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>, <span class="built_in">array</span>[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    <span class="comment">/* array is neve free, leaking 10*sizeof(int) of memory each iteration */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> iterations = atoi(argv[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;iterations; i++)</span><br><span class="line">        print_ten_integers();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>Can use Valgrind to detect memory leaks<h1 id="The-C-Standard-Library"><a href="#The-C-Standard-Library" class="headerlink" title="The C Standard Library"></a>The C Standard Library</h1></li>
<li>Already saw: <code>printf</code>, <code>malloc</code>, <code>atoi</code>, etc</li>
<li>can use <code>man &lt;function name&gt;</code> to find function description, prototype, required headers, return value in a <em>Linux terminal</em><h2 id="String-Copy"><a href="#String-Copy" class="headerlink" title="String Copy"></a>String Copy</h2>The format of String copy:<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">strcpy</span><span class="params">(<span class="keyword">char</span> *dest, <span class="keyword">const</span> <span class="keyword">char</span> *src)</span></span>; </span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">strncpy</span><span class="params">(<span class="keyword">char</span> *dest, <span class="keyword">const</span> <span class="keyword">char</span> *src, <span class="keyword">size_t</span> n)</span></span>;</span><br></pre></td></tr></table></figure>
Example:<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *string1 = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    <span class="keyword">char</span> *string2 = string1;   <span class="comment">// this is not a string copy!</span></span><br><span class="line">    <span class="keyword">char</span> string3[<span class="number">10</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* not super safe, what happen if string1 &gt; string3? */</span></span><br><span class="line">    <span class="built_in">strcpy</span>(string3, string1);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* better */</span></span><br><span class="line">    <span class="built_in">strncpy</span>(string3, string1, <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;string1 @%p: %s\n&quot;</span>, string1, string1); <span class="comment">// string1 @0x55bcccbf98a4: hello</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;string2 @%p: %s\n&quot;</span>, string2, string2); <span class="comment">// string1 @0x55bcccbf98a4: hello</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;string3 @%p: %s\n&quot;</span>, string3, string3); <span class="comment">// string3 @0x7ffda803dbee: hello</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="String-Concatenation-连结"><a href="#String-Concatenation-连结" class="headerlink" title="String Concatenation 连结"></a>String Concatenation 连结</h2>The format of String Concatenation:<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">strcat</span><span class="params">(<span class="keyword">char</span> *dest, <span class="keyword">const</span> <span class="keyword">char</span> *src)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">strncat</span><span class="params">(<span class="keyword">char</span> *dest, <span class="keyword">const</span> <span class="keyword">char</span> *src, <span class="keyword">size_t</span> n)</span></span>;</span><br></pre></td></tr></table></figure>
Example:<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">char</span> world[<span class="number">6</span>] = <span class="string">&quot;world&quot;</span>;</span><br><span class="line">  <span class="keyword">char</span> s1[<span class="number">32</span>];</span><br><span class="line">  <span class="keyword">char</span> s2[<span class="number">32</span>];</span><br><span class="line"></span><br><span class="line">  <span class="built_in">strcpy</span>(s1, <span class="string">&quot;hello &quot;</span>);</span><br><span class="line">  <span class="built_in">strcpy</span>(s2, <span class="string">&quot;hello &quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">strcat</span>(s1, world);       <span class="comment">// not very safe</span></span><br><span class="line">  <span class="built_in">strncat</span>(s2, world, <span class="number">32</span>);  <span class="comment">// better</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;s1: %s\n&quot;</span>, s1); <span class="comment">//s1: hello world</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;s2: %s\n&quot;</span>, s2); <span class="comment">//s2: hello world</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Format-based-String-Creation"><a href="#Format-based-String-Creation" class="headerlink" title="Format-based String Creation"></a>Format-based String Creation</h2>Format is:</li>
</ul>
<p><code>int sprintf(char *str, const char *format, ...);</code><br>Fill a string with printf-like specifiers 用类似 printf 的说明符填充字符串</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">12</span>;</span><br><span class="line">    <span class="keyword">float</span> b = <span class="number">4.5</span>;</span><br><span class="line">    <span class="keyword">char</span> *s = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    <span class="keyword">char</span> <span class="built_in">string</span>[<span class="number">64</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sprintf</span>(<span class="built_in">string</span>, <span class="string">&quot;a is %d, b is %f, s is %s\n&quot;</span>, a, b, s);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, <span class="built_in">string</span>); <span class="comment">// a is 12, b is 4.500000, s is hello</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="String-Manipulation"><a href="#String-Manipulation" class="headerlink" title="String Manipulation"></a>String Manipulation</h2><ul>
<li>Get string length with <code>strlen</code></li>
<li>Compare two strings with <code>strcmp</code>, returns 0 if they match<br>The formats of them are:</li>
</ul>
<p><code>size_t strlen(const char *s)</code></p>
<p><code>int strcmp(const char *s1, const char *s2);</code></p>
<p>Example:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="comment">/* ... */</span></span><br><span class="line"><span class="keyword">char</span> *s1 = <span class="string">&quot;hello&quot;</span>; <span class="keyword">char</span> *s2 = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line"><span class="keyword">char</span> *s3 = <span class="string">&quot;not hello&quot;</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;strcmp(s1, s2) returns: %d\n&quot;</span>, <span class="built_in">strcmp</span>(s1, s2));   <span class="comment">// 0</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;strcmp(s1, s3) returns: %d\n&quot;</span>, <span class="built_in">strcmp</span>(s1, s3));   <span class="comment">// -6</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;length of s1: %d\n&quot;</span>, <span class="built_in">strlen</span>(s1)); <span class="comment">// 5</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;length of s2: %d\n&quot;</span>, <span class="built_in">strlen</span>(s2)); <span class="comment">// 5</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;length of s3: %d\n&quot;</span>, <span class="built_in">strlen</span>(s3)); <span class="comment">// 9</span></span><br></pre></td></tr></table></figure>
<h2 id="Console-Input"><a href="#Console-Input" class="headerlink" title="Console Input"></a>Console Input</h2><p>Formats:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">fgets</span><span class="params">(<span class="keyword">char</span> *s, <span class="keyword">int</span> size, FILE *stream)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">scanf</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *format, ...)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>fgets()</code> can read from any open file, but <code>scanf()</code> only reads standard input.</li>
<li><code>fgets()</code> reads ‘a line of text’ from a file; <code>scanf()</code> can be used for that but also handles conversions from string to built in numeric types.</li>
<li>Many people will use <code>fgets()</code> to read a line of data and then use <code>scanf()</code> to dissect it. From <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/1252132/difference-between-scanf-and-fgets#:~:text=fgets()%20can%20read%20from,to%20built%20in%20numeric%20types.">stackoverflow</a></li>
</ul>
<p>Example:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> int1, int2;</span><br><span class="line">  <span class="keyword">double</span> double1;</span><br><span class="line">  <span class="keyword">float</span> float1;</span><br><span class="line">  <span class="keyword">char</span> s[<span class="number">128</span>];</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Please input a string:\n&quot;</span>);</span><br><span class="line">  fgets(s, <span class="number">128</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Please input an integer:\n&quot;</span>);</span><br><span class="line">  <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;int1);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Please input a float:\n&quot;</span>);</span><br><span class="line">  <span class="built_in">scanf</span>(<span class="string">&quot;%lf&quot;</span>, &amp;double1); <span class="comment">/* make sure to us %lf for double and %f for float */</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Please enter an integer and a float separated by a space\n&quot;</span>);</span><br><span class="line">  <span class="built_in">scanf</span>(<span class="string">&quot;%d %f&quot;</span>, &amp;int2, &amp;float1);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;You have entered: %d, %d, %lf, %f, and %s\n&quot;</span>, int1, int2, double1,</span><br><span class="line">          float1, s);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Memory-Manipulation"><a href="#Memory-Manipulation" class="headerlink" title="Memory Manipulation"></a>Memory Manipulation</h2><ul>
<li>Writing bytes to memory, Copying memory<br>Formats:<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">memset</span><span class="params">(<span class="keyword">void</span> *s, <span class="keyword">int</span> c, <span class="keyword">size_t</span> n)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">memcpy</span><span class="params">(<span class="keyword">void</span> *dest, <span class="keyword">void</span> *src, <span class="keyword">size_t</span> n)</span></span>;</span><br></pre></td></tr></table></figure>
<code>memset</code> sets for char (or other type) variable, make <code>n</code> size of it to <code>c</code></li>
</ul>
<p><code>memcpy</code> copy from <code>src</code> to <code>dest</code> in the size of <code>n</code><br>Example:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;   // needed for memcpy and memset</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> buffer_size = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">char</span> *ptr1  = <span class="built_in">malloc</span>(buffer_size);</span><br><span class="line">    <span class="keyword">char</span> *ptr2 = <span class="built_in">malloc</span>(buffer_size);</span><br><span class="line">    <span class="keyword">if</span>(ptr1 &amp;&amp; ptr2) &#123;</span><br><span class="line">        <span class="built_in">memset</span>(ptr1, <span class="number">0x40</span>, buffer_size);  <span class="comment">// 0x40 is ascii code for @</span></span><br><span class="line">        <span class="built_in">memcpy</span>(ptr2, ptr1, buffer_size);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;buffer_size; i++) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;ptr1[%d] = %c\n&quot;</span>, i, ptr1[i]); <span class="comment">//ptr1[0] = @</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;ptr2[%d] = %c\n&quot;</span>, i, ptr2[i]); <span class="comment">//ptr2[0] = @ all are set to @!</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Math-functions"><a href="#Math-functions" class="headerlink" title="Math functions"></a>Math functions</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">ceil</span><span class="params">(<span class="keyword">double</span> x)</span></span>; <span class="comment">// the ceil function returns the smallest integer that is greater than or equal to x</span></span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">ceilf</span><span class="params">(<span class="keyword">float</span> x)</span></span>;  <span class="comment">// the same result as ceil</span></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">sqrt</span><span class="params">(<span class="keyword">double</span> x)</span></span>; <span class="comment">// square root</span></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">pow</span><span class="params">(<span class="keyword">double</span> x)</span></span>; <span class="comment">// power</span></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">cos</span><span class="params">(<span class="keyword">double</span> x)</span></span>; <span class="comment">//cosine function</span></span><br></pre></td></tr></table></figure>
<p>Example:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;math.h&gt; // needed for math functions</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ceil 2.5:  %f\n&quot;</span>, <span class="built_in">ceil</span>(<span class="number">2.5</span>)); <span class="comment">//ceil 2.5:  3.000000</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ceilf 2.5:  %f\n&quot;</span>, ceilf(<span class="number">2.5</span>)); <span class="comment">//ceilf 2.5:  3.000000</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;floor 2.5: %f\n&quot;</span>, <span class="built_in">floor</span>(<span class="number">2.5</span>)); <span class="comment">//floor 2.5: 2.000000</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;2^5:       %f\n&quot;</span>, <span class="built_in">pow</span>(<span class="number">2</span>, <span class="number">5</span>)); <span class="comment">//2^5:       32.000000</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;sqrt(4):   %f\n&quot;</span>, <span class="built_in">sqrt</span>(<span class="number">4</span>)); <span class="comment">//sqrt(4):   2.000000</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Time"><a href="#Time" class="headerlink" title="Time"></a>Time</h2><ul>
<li>Sleeping<ul>
<li>format<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">sleep</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> seconds)</span></span>; <span class="comment">// parameter as second</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">usleep</span><span class="params">(<span class="keyword">useconds_t</span> usec)</span></span>; <span class="comment">//suspends the current process for the number of microseconds passed to it</span></span><br></pre></td></tr></table></figure></li>
<li>1 s = 1000000 µs</li>
<li>Example<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt; // needed for sleep and usleep</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;hello!\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Sleeping for 2 seconds ...\n&quot;</span>);</span><br><span class="line">    sleep(<span class="number">2</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Now sleeping for .5 seconds ...\n&quot;</span>);</span><br><span class="line">    usleep(<span class="number">500000</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>Current Time<ul>
<li>format<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">time_t</span> <span class="title">time</span><span class="params">(<span class="keyword">time_t</span> *tloc)</span></span>;   <span class="comment">// time_t is generally a long long unsigned int</span></span><br></pre></td></tr></table></figure></li>
<li>Example<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;   // needed for time()</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> t = time(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Number of seconds elapsed since the epoch (01/01/1970):\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%llu\n&quot;</span>, t); <span class="comment">// 1650917906</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>Measuring Execution Time<ul>
<li>Format<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">gettimeofday</span><span class="params">(struct timeval *tv, struct timezone *tz)</span></span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> &#123;</span></span><br><span class="line">    <span class="keyword">time_t</span>      tv_sec;     <span class="comment">/* seconds (type: generally long unsigned) */</span></span><br><span class="line">    <span class="keyword">suseconds_t</span> tv_usec;    <span class="comment">/* microseconds (type: generally long unsigned) */</span></span><br><span class="line"> &#125;;</span><br><span class="line"> <span class="comment">// A pointer to a struct timeval as parameter</span></span><br></pre></td></tr></table></figure></li>
<li>Example<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt; // needed for gettimeofday</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tv</span>, <span class="title">start</span>, <span class="title">stop</span>, <span class="title">elapsed</span>;</span></span><br><span class="line">    gettimeofday(&amp;tv, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Seconds since the epoch: %lu.%06lu\n&quot;</span>, tv.tv_sec, tv.tv_usec); <span class="comment">// get second and microsecond</span></span><br><span class="line">    gettimeofday(&amp;start, <span class="literal">NULL</span>); <span class="comment">// set a start time stamp</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">1000000000</span>; i++); <span class="comment">// implementing a large loop</span></span><br><span class="line">    gettimeofday(&amp;stop, <span class="literal">NULL</span>); <span class="comment">// set an ending time stamp</span></span><br><span class="line">    timersub(&amp;stop, &amp;start, &amp;elapsed); <span class="comment">// stop-start = elapsed</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Busy loop took %lu.%06lu seconds\n&quot;</span>, elapsed.tv_sec,</span><br><span class="line">            elapsed.tv_usec);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="File-I-O"><a href="#File-I-O" class="headerlink" title="File I/O"></a>File I/O</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">open</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *pathname, <span class="keyword">int</span> flags, <span class="keyword">mode_t</span> mode)</span></span>;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><code>open</code> creates a reference to a file: <em>file descriptor</em><ul>
<li><code>pathname</code>: path of the file</li>
<li><code>flags</code>:<ul>
<li>Access mode: <code>O_RDONLY</code>, <code>O_WRONLY</code>, <code>O_RDWR</code></li>
<li>create the file if it doesn’t exist: <code>O_CREAT</code></li>
<li>Truncate截短 the file size to 0 if it exists: <code>O_TRUNC</code><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// open /home/pierre/test, read-write mode, and create the file if it does not</span></span><br><span class="line"><span class="comment">// exists with r/w/x permissions</span></span><br><span class="line"><span class="comment">// I_IRWXU means read, write, execute/search by</span></span><br><span class="line"><span class="keyword">int</span> file_descriptor = open(<span class="string">&quot;/home/pierre/test&quot;</span>, O_RDWR | O_CREAT, S_IRWXU);</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">read</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count)</span></span>;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
<li><code>read</code> attempts to read bytes from a file<ul>
<li><code>fd</code> is the file descriptor, previously created with <code>open</code></li>
<li><code>buf</code> is the address of the buffer that will receive the content road</li>
<li><code>count</code> is the number of bytes to try to read</li>
<li>return the number of bytes <em>actually</em> read<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> bytes_read = (file_descriptor, buffer, <span class="number">10</span>);</span><br><span class="line"><span class="keyword">if</span>(bytes_read == <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="comment">/* error */</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span>(bytes_read != <span class="number">10</span>) &#123;</span><br><span class="line">    <span class="comment">/* technically not an error */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">write</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">const</span> <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count)</span></span>;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><code>write</code> attemps to write <code>count</code> bytes from <code>buf</code> int the file corresponding to <code>fd</code><ul>
<li>Returns the number of bytes actually written</li>
<li>File system can be full<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> bytes_written = (file_descriptor, buffer, <span class="number">10</span>);</span><br><span class="line"><span class="keyword">if</span>(bytes_written == <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="comment">/* error */</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span>(bytes_written != <span class="number">10</span>) &#123;</span><br><span class="line">    <span class="comment">/* technically not an error */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">close</span><span class="params">(<span class="keyword">int</span> fd)</span></span></span><br></pre></td></tr></table></figure></li>
<li><code>close</code> terminates file I/O on a given descriptor<br>Example:<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;  // needed for open</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;   // needed for open</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;      // needed for open</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;     // needed for read and write</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> fd1;</span><br><span class="line">  <span class="keyword">char</span> *buffer = <span class="string">&quot;hello, world!&quot;</span>;</span><br><span class="line">  fd1 = open(<span class="string">&quot;./test&quot;</span>, O_WRONLY | O_TRUNC | O_CREAT, S_IRUSR | S_IWUSR);</span><br><span class="line">  <span class="keyword">if</span>(fd1 == <span class="number">-1</span>) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;error with open\n&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/* write &#x27;hello, world!&#x27; in the file */</span></span><br><span class="line">  <span class="keyword">if</span>(write(fd1, buffer, <span class="built_in">strlen</span>(buffer)) != <span class="built_in">strlen</span>(buffer)) &#123;</span><br><span class="line">    <span class="comment">// write will return the number of bytes actualy written</span></span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;issue writing\n&quot;</span>);</span><br><span class="line">      close(fd1); <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/* write it again */</span></span><br><span class="line">  <span class="keyword">if</span>(write(fd1, buffer, <span class="built_in">strlen</span>(buffer)) != <span class="built_in">strlen</span>(buffer)) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;issue writing\n&quot;</span>);</span><br><span class="line">      close(fd1); <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  close(fd1);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
The result is a txt file called “test” with “hello, world!hello, world!<br>“ in it.</li>
</ul>
</li>
</ul>
<p>Read Example which assume the last example has executed</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Assume ./test was previously created with the write example program</span></span><br><span class="line"><span class="keyword">char</span> buffer2[<span class="number">10</span>];</span><br><span class="line"><span class="keyword">int</span> fd2 = open(<span class="string">&quot;./test&quot;</span>, O_RDONLY, <span class="number">0x0</span>);</span><br><span class="line"><span class="keyword">int</span> bytes_read;</span><br><span class="line"><span class="keyword">if</span>(fd2 == <span class="number">-1</span>) &#123; <span class="built_in">printf</span>(<span class="string">&quot;error open\n&quot;</span>); <span class="keyword">return</span> <span class="number">-1</span>; &#125;</span><br><span class="line"><span class="comment">/* read 9 bytes */</span></span><br><span class="line"><span class="keyword">if</span>(read(fd2, buffer2, <span class="number">9</span>) != <span class="number">9</span>) &#123; <span class="comment">//read 9 bytes from fd2 to buffer 2</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;error reading\n&quot;</span>); close(fd2); <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* fix the string and print it */</span></span><br><span class="line">buffer2[<span class="number">10</span>] = <span class="string">&#x27;\0&#x27;</span>; <span class="comment">//read: &#x27;hello, wo&#x27;</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;read: &#x27;%s&#x27;\n&quot;</span>, buffer2);</span><br><span class="line"><span class="comment">/* read 9 bytes again */</span></span><br><span class="line">bytes_read = read(fd2, buffer2, <span class="number">9</span>);</span><br><span class="line"><span class="keyword">if</span>(bytes_read != <span class="number">9</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;error reading\n&quot;</span>); close(fd2); <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* fix the string and print it */</span></span><br><span class="line">buffer2[<span class="number">10</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;read: &#x27;%s&#x27;\n&quot;</span>, buffer2); <span class="comment">//read: &#x27;rld!hello&#x27;</span></span><br><span class="line">close(fd2);</span><br></pre></td></tr></table></figure>
<h2 id="Random-Numbers"><a href="#Random-Numbers" class="headerlink" title="Random Numbers"></a>Random Numbers</h2><ul>
<li><p>V1: get numbers between 0 and RAND_MAX</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">10</span>; i++)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>, rand());</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>); <span class="comment">// 1804289383 846930886 1681692777 1714636915 1957747793 424238335 719885386 1649760492 596516649 1189641421 </span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>V2: numbers between 0 and 99 with modulo</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">10</span>; i++)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>, rand()%<span class="number">100</span>); <span class="comment">// 83 86 77 15 93 35 86 92 49 21 </span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>V3: display a different sequence each time we launch the program</p>
<ul>
<li>makes use of the computer’s internal clock to control the choice of the seed. Since time is continually changing, the seed is forever changing.</li>
<li> void srand(unsigned int seed) seeds the random number generator used by the function rand.</li>
<li> <code>seed</code> − This is an integer value to be used as seed by the pseudo-random number generator algorithm.</li>
<li>Because the number is set after compiling the program!<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    srand(time(<span class="literal">NULL</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">10</span>; i++)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>, rand()%<span class="number">100</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Error-Management"><a href="#Error-Management" class="headerlink" title="Error Management"></a>Error Management</h2></li>
</ul>
</li>
<li><p>The variable <code>errno</code> can be used to get more information about the failure of many functions of the standard library</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;  // needed for errno and perror</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> fd = open(<span class="string">&quot;a/file/that/does/not/exist&quot;</span>, O_RDONLY, <span class="number">0x0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Open always returns -1 on failure, but it can be due to many different</span></span><br><span class="line"><span class="comment">    * reasons */</span></span><br><span class="line">  <span class="keyword">if</span>(fd == <span class="number">-1</span>) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;open failed! errno is: %d\n&quot;</span>, errno);</span><br><span class="line">      <span class="comment">// the errno is 2</span></span><br><span class="line">      <span class="comment">/* errno is an integer code corresponding to a given reason. To format</span></span><br><span class="line"><span class="comment">        * it in a textual way use perror: */</span></span><br><span class="line">      perror(<span class="string">&quot;open&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>Errors are listed, more can find in the <a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man3/errno.3.html">function man page</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> 1   EPERM             Operation not permitted</span><br><span class="line"> 2   ENOENT            No such file or directory</span><br><span class="line"> 3   ESRCH             No such process</span><br><span class="line"> 4   EINTR             Interrupted system call</span><br><span class="line"> 5   EIO               Input&#x2F;output error</span><br><span class="line"> 6   ENXIO             No such device or address</span><br><span class="line"> 7   E2BIG             Argument list too long</span><br><span class="line"> 8   ENOEXEC           Exec format error</span><br><span class="line"> 9   EBADF             Bad file descriptor</span><br><span class="line">10   ECHILD            No child processes</span><br></pre></td></tr></table></figure>
<h1 id="Classes-and-Objects-in-C"><a href="#Classes-and-Objects-in-C" class="headerlink" title="Classes and Objects in C++"></a>Classes and Objects in C++</h1></li>
<li><p>Superset of C with many additional functionalities, in particular Object-Oriented Programming (OOP)</p>
<ul>
<li>Everything we saw for C will also work in C++</li>
</ul>
</li>
<li><p>3 fundamental concepts of OOP:</p>
<ul>
<li>Encapsulation of data and code manipulating it with classes and objects</li>
<li>Inheritance, that helps to <em>reuse</em> code for components of a program that share similar characteristics</li>
<li>Polymorphism多态性 lets the programmer define multiple implementation of functions with the same name<h2 id="Classes-and-Objects"><a href="#Classes-and-Objects" class="headerlink" title="Classes and Objects"></a>Classes and Objects</h2></li>
</ul>
</li>
<li><p>Object Oriented Programming binds together some data and the code that is manipulating it into objects</p>
</li>
<li><p>The code for manipulating similar objects is defined once into a class</p>
</li>
<li><p>The programmer uses the class as a pattern to create (instantiate) as many objects as needed</p>
</li>
<li><p>By convention, class names start with a capital letter and use camel case</p>
</li>
<li><p>Member variables represent data attached to the object created from the class</p>
<ul>
<li>Different objects of the same class can have different values for member variables</li>
</ul>
</li>
<li><p>Member variables represent data attached to the object created from the class Member functions are functions, i.e. the code manipulating the data</p>
<ul>
<li>Prototype原型 in the class, implemented outside with :: </li>
</ul>
</li>
<li><p>Example:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SampleClass</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">int</span> data;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> val)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SampleClass::add</span><span class="params">(<span class="keyword">int</span> val)</span> </span>&#123;</span><br><span class="line">    data = data + val;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// create two objects, instances of SampleClass</span></span><br><span class="line">  SampleClass obj1, obj2;</span><br><span class="line">  obj1.data = <span class="number">42</span>;</span><br><span class="line">  obj2.data = <span class="number">12</span>;</span><br><span class="line">  obj1.add(<span class="number">58</span>);</span><br><span class="line">  obj2.add(<span class="number">8</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;obj1 data: %d\n&quot;</span>, obj1.data); <span class="comment">//obj1 data: 100</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;obj2 data: %d\n&quot;</span>, obj2.data); <span class="comment">//obj2 data: 20</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Encapsulation"><a href="#Encapsulation" class="headerlink" title="Encapsulation"></a>Encapsulation</h2></li>
<li><p>Encapsulation: prevent <em>direct access</em> to part of the member variables/functions of a class from outside of this class</p>
<ul>
<li>To force the outside code to use a well-defined interface, i.e. the member functions and (rarely) variables still available to it<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BankAccount</span> &#123;</span></span><br><span class="line"><span class="comment">// All attributes/methods set as private are unacessible from outside the class</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">int</span> _balance = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> _transaction_num = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">update_balance</span><span class="params">(<span class="keyword">int</span> val)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">get_balance</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">get_transaction_num</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Add val to the balance and increment the number of transactions */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">BankAccount::update_balance</span><span class="params">(<span class="keyword">int</span> val)</span> </span>&#123;</span><br><span class="line">    _balance += val;</span><br><span class="line">    _transaction_num++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Return the current value of the balance */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">BankAccount::get_balance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> _balance;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Return the number of transactions */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">BankAccount::get_transaction_num</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> _transaction_num;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    BankAccount ba;</span><br><span class="line">    ba.update_balance(<span class="number">100</span>); <span class="comment">// payday 发薪日</span></span><br><span class="line">    ba.update_balance(<span class="number">-20</span>); <span class="comment">// groceries 杂货</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;The account balance is %d after %d transactions\n&quot;</span>,</span><br><span class="line">            ba.get_balance(), ba.get_transaction_num());</span><br><span class="line">    <span class="comment">// output: The account balance is 80 after 2 transactions</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>Have as much member variables private as possible</p>
</li>
<li><p>Have funcions to read/write these only if needed</p>
<ul>
<li>Use accessors or getters and setters</li>
<li>Example:<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> &#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">int</span> _foo = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">double</span> _bar = <span class="number">0.0</span>;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">set_foo</span><span class="params">(<span class="keyword">int</span> val)</span></span>; <span class="comment">// setter</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">get_foo</span><span class="params">()</span></span>;         <span class="comment">// getter</span></span><br><span class="line">    <span class="function"><span class="keyword">double</span> <span class="title">get_bar</span><span class="params">()</span></span>;      <span class="comment">// getter</span></span><br><span class="line">    <span class="comment">/* ... */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MyClass::set_foo</span><span class="params">(<span class="keyword">int</span> val)</span> </span>&#123;</span><br><span class="line">    _foo = val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">MyClass::get_foo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> _foo;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">MyClass::get_bar</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> _bar;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    MyClass c1, c2;</span><br><span class="line">    c1.set_foo(<span class="number">42</span>);</span><br><span class="line">    c2.set_foo(<span class="number">24</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;c1&#x27;s foo: %d, c2&#x27;s foo: %d\n&quot;</span>, c1.get_foo(), c2.get_foo());</span><br><span class="line">    <span class="comment">// c1&#x27;s foo: 42, c2&#x27;s foo: 24</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Constructors"><a href="#Constructors" class="headerlink" title="Constructors"></a>Constructors</h2></li>
</ul>
</li>
<li><p>Initialise member variables at object creation time with a constructor</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BankAccount</span> &#123;</span></span><br><span class="line"><span class="comment">// All attributes/methods set as private are unacessible from outside the class</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">int</span> _balance;</span><br><span class="line">    <span class="keyword">int</span> _transaction_num;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    BankAccount(<span class="keyword">int</span> initial_balance);</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">update_balance</span><span class="params">(<span class="keyword">int</span> val)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">get_balance</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">get_transaction_num</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Constructor */</span></span><br><span class="line"><span class="comment">// now can set any value as intitial balance</span></span><br><span class="line">BankAccount::BankAccount(<span class="keyword">int</span> initial_balance) &#123;</span><br><span class="line">    _balance = initial_balance;</span><br><span class="line">    _transaction_num = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Destructors"><a href="#Destructors" class="headerlink" title="Destructors"></a>Destructors</h2></li>
<li><p>Member functions called when the object is destroyed<br>I.e. when it goes out of scope for the stack-allocated objects we have seen this far</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BankAccount</span> &#123;</span></span><br><span class="line"><span class="comment">// All attributes/methods set as private are unacessible from outside the class</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">int</span> _balance;</span><br><span class="line">    <span class="keyword">int</span> _transaction_num;</span><br><span class="line">    <span class="keyword">char</span> *_account_name;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    BankAccount(<span class="keyword">char</span> *name, <span class="keyword">int</span> initial_balance);</span><br><span class="line">    ~BankAccount();</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">update_balance</span><span class="params">(<span class="keyword">int</span> val)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">get_balance</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">get_transaction_num</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">char</span> *<span class="title">get_name</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Constructor */</span></span><br><span class="line">BankAccount::BankAccount(<span class="keyword">char</span> *name, <span class="keyword">int</span> initial_balance) &#123;</span><br><span class="line">    _balance = initial_balance;</span><br><span class="line">    _transaction_num = <span class="number">0</span>;</span><br><span class="line">    _account_name =</span><br><span class="line">        (<span class="keyword">char</span> *)<span class="built_in">malloc</span>((<span class="built_in">strlen</span>(name) + <span class="number">1</span>) * <span class="keyword">sizeof</span>(<span class="keyword">char</span>));</span><br><span class="line">    <span class="built_in">strcpy</span>(_account_name, name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* destructor */</span></span><br><span class="line">BankAccount::~BankAccount() &#123;</span><br><span class="line">    <span class="built_in">free</span>(_account_name);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// printf here to see when the destructor is called:</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;destructor called\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Add val to the balance and increment the number of transactions */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">BankAccount::update_balance</span><span class="params">(<span class="keyword">int</span> val)</span> </span>&#123;</span><br><span class="line">    _balance += val;</span><br><span class="line">    _transaction_num++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Return the current value of the balance */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">BankAccount::get_balance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> _balance;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Return the number of transactions */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">BankAccount::get_transaction_num</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> _transaction_num;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Return the name of the account */</span></span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">BankAccount::get_name</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> _account_name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">11</span>] = <span class="string">&quot;my_account&quot;</span>;</span><br><span class="line">    <span class="function">BankAccount <span class="title">ba</span><span class="params">(name, <span class="number">100</span>)</span></span>; <span class="comment">//set name and initial balance</span></span><br><span class="line"></span><br><span class="line">    ba.update_balance(<span class="number">100</span>); <span class="comment">// payday</span></span><br><span class="line">    ba.update_balance(<span class="number">-20</span>); <span class="comment">// groceries</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;The account \&quot;%s\&quot; balance is %d after %d transactions\n&quot;</span>,</span><br><span class="line">            ba.get_name(), ba.get_balance(), ba.get_transaction_num());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// The output is:</span></span><br><span class="line"><span class="comment">//The account &quot;my_account&quot; balance is 180 after 2 transactions</span></span><br><span class="line"><span class="comment">// destructor called</span></span><br></pre></td></tr></table></figure>
<h2 id="This-Pointer"><a href="#This-Pointer" class="headerlink" title="This Pointer"></a>This Pointer</h2></li>
<li><p>In any member function (including destructors and constructors), one can obtain a pointer to the current object with this</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span> &#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">int</span> x;</span><br><span class="line">    <span class="keyword">int</span> y;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    Test(<span class="keyword">int</span> x, <span class="keyword">int</span> y);</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* This constructor&#x27;s parameter have the same names as the class member</span></span><br><span class="line"><span class="comment"> * variables */</span></span><br><span class="line">Test::Test(<span class="keyword">int</span> x, <span class="keyword">int</span> y) &#123;</span><br><span class="line">    <span class="keyword">this</span>-&gt;x = x; <span class="comment">// x corresponds to the parameter, this-&gt;x to the member</span></span><br><span class="line">    <span class="keyword">this</span>-&gt;y = y; <span class="comment">// this-&gt;x equal to (*this).x</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Test::print</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;x: %d, y: %d\n&quot;</span>, x, y);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;x: %d, y: %d\n&quot;</span>, <span class="keyword">this</span>-&gt;x, <span class="keyword">this</span>-&gt;y);  <span class="comment">// same thing</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="function">Test <span class="title">t</span><span class="params">(<span class="number">1</span>, <span class="number">2</span>)</span></span>;</span><br><span class="line">    t.print();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="C-Dynamic-Object-Allocation-and-Dynamic-Arrays"><a href="#C-Dynamic-Object-Allocation-and-Dynamic-Arrays" class="headerlink" title="C++: Dynamic Object Allocation and Dynamic Arrays"></a>C++: Dynamic Object Allocation and Dynamic Arrays</h1><h2 id="Dynamic-Object-Allocation"><a href="#Dynamic-Object-Allocation" class="headerlink" title="Dynamic Object Allocation"></a>Dynamic Object Allocation</h2></li>
<li><p><code>malloc</code> and <code>free</code> are available in C++</p>
<ul>
<li>Good for allocating arrays/buffers of primitive原始 types(<code>int</code>, <code>char</code>, etc.)</li>
</ul>
</li>
<li><p><code>new</code> and <code>delete</code> to allocate objects dynamically</p>
<ul>
<li>Use <code>malloc</code> and <code>free</code> under the hood</li>
<li>Allocate memory and invoke contructors/destructors<ul>
<li>Should be preferred to malloc/free 优先于malloc/free<h2 id="Dynamic-Arrays"><a href="#Dynamic-Arrays" class="headerlink" title="Dynamic Arrays"></a>Dynamic Arrays</h2></li>
</ul>
</li>
</ul>
</li>
<li><p>vector class</p>
</li>
<li><p>Variable size arrays, their allocated memory (on the heap) is managed automatically by the language</p>
</li>
<li><p>They also embed their size</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt; // c++ include</span></span></span><br><span class="line"><span class="comment">// vector is in the std namespace</span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="comment">/* apply a few random transactions on account pairs within the array</span></span><br><span class="line"><span class="comment"> * Note that we have a dynamic array which embeds its size so no need to pass</span></span><br><span class="line"><span class="comment"> * the number of accounts as parameter anymore</span></span><br><span class="line"><span class="comment"> * Also note that we pass a pointer to the vector rather than the vector</span></span><br><span class="line"><span class="comment"> * to avoid a costly copy with long vectors! */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rnd_transac</span><span class="params">(<span class="built_in">vector</span>&lt;BankAccount *&gt; *b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> num = rand()%<span class="number">10</span> + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> n = b-&gt;size();  <span class="comment">// returns the amount of elements in the vector</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;num; i++) &#123;</span><br><span class="line">        BankAccount *source = (*b)[rand()%n]; <span class="comment">// we can access a vector with []</span></span><br><span class="line">        BankAccount *target = (*b)[rand()%n];</span><br><span class="line">        <span class="keyword">int</span> amount = rand()%<span class="number">15</span>;</span><br><span class="line">        target-&gt;update_balance(amount);</span><br><span class="line">        source-&gt;update_balance(-amount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// a vector of BankAccount pointers:</span></span><br><span class="line">  <span class="built_in">vector</span>&lt;BankAccount *&gt; accounts;</span><br><span class="line">  <span class="keyword">int</span> n;</span><br><span class="line">  n = atoi(argv[<span class="number">1</span>]);</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;n; i++) &#123;</span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">32</span>];</span><br><span class="line">    <span class="built_in">sprintf</span>(name, <span class="string">&quot;account %d&quot;</span>, i);</span><br><span class="line">    BankAccount *b = <span class="keyword">new</span> BankAccount(name, <span class="number">100</span>);</span><br><span class="line">    accounts.push_back(b); <span class="comment">// add an element at the end of the vector</span></span><br><span class="line">  &#125;</span><br><span class="line">  rnd_transac(&amp;accounts);</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;n; i++) &#123;</span><br><span class="line">    BankAccount *b = accounts[i];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="comment">/* ... */</span>);</span><br><span class="line">    <span class="comment">// this frees what is pointed by b but does not remove b from the</span></span><br><span class="line">    <span class="comment">// vector, we&#x27;ll clear it out below as we are currently iterating on</span></span><br><span class="line">    <span class="comment">// that vector</span></span><br><span class="line">    <span class="keyword">delete</span> b;</span><br><span class="line">  &#125;</span><br><span class="line">  accounts.clear(); <span class="comment">// remove all elements from the vector</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Inheritance-in-C"><a href="#Inheritance-in-C" class="headerlink" title="Inheritance in C++"></a>Inheritance in C++</h1></li>
<li><p>Goal: reusing code between similar classes</p>
<ul>
<li>Class Person (Base class) — Class Student   (Derived classes)</li>
<li><pre><code>                 |___ Class Professor
</code></pre>
</li>
</ul>
</li>
<li><p>Base class declaration:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> &#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">char</span> *_name;</span><br><span class="line">    <span class="keyword">int</span> _id;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    Person(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">int</span> id);</span><br><span class="line">    ~Person();</span><br><span class="line">    <span class="function"><span class="keyword">char</span> *<span class="title">get_name</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">get_id</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li>
<li><p>Derived classes declarations:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span> :</span> <span class="keyword">public</span> Person &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">double</span> _gpa;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    Student(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">int</span> id,</span><br><span class="line">        <span class="keyword">double</span> gpa);</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">update_gpa</span><span class="params">(<span class="keyword">double</span> new_gpa)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">double</span> <span class="title">get_gpa</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Professor</span> :</span> <span class="keyword">public</span> Person &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">int</span> _courses_taught;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    Professor(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">int</span> id,</span><br><span class="line">        <span class="keyword">int</span> courses_taught);</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">update_courses_taught</span><span class="params">(<span class="keyword">int</span> n)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">get_courses_taught</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li>
<li><p>Methods implementations</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">Person::Person(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">int</span> id) &#123;</span><br><span class="line">    _name = <span class="keyword">new</span> <span class="keyword">char</span>[<span class="built_in">strlen</span>(name)+<span class="number">1</span>];</span><br><span class="line">    <span class="built_in">strcpy</span>(_name, name);</span><br><span class="line">    _id = id;</span><br><span class="line">&#125;</span><br><span class="line">Person::~Person() &#123;</span><br><span class="line">    <span class="keyword">delete</span> [] _name;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">Person::get_name</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> _name;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">Person::get_id</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> _id;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Student::Student(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">int</span> id, <span class="keyword">double</span> gpa) : Person(name, id)</span><br><span class="line">    &#123; _gpa = gpa; &#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Student::update_gpa</span><span class="params">(<span class="keyword">double</span> new_gpa)</span></span></span><br><span class="line"><span class="function">    </span>&#123; _gpa = new_gpa; &#125;</span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">Student::get_gpa</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123; <span class="keyword">return</span> _gpa; &#125;</span><br><span class="line">Professor::Professor(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">int</span> id, <span class="keyword">int</span> courses_taught) : Person(name, id)</span><br><span class="line">    &#123; _courses_taught = courses_taught; &#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Professor::update_courses_taught</span><span class="params">(<span class="keyword">int</span> n)</span></span></span><br><span class="line"><span class="function">    </span>&#123; _courses_taught = n; &#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">Professor::get_courses_taught</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123; <span class="keyword">return</span> _courses_taught; &#125;</span><br></pre></td></tr></table></figure></li>
<li><p>usage in external code:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">  <span class="function">Person <span class="title">p1</span><span class="params">(<span class="string">&quot;James&quot;</span>, <span class="number">1000</span>)</span></span>;</span><br><span class="line">  <span class="function">Student <span class="title">p2</span><span class="params">(<span class="string">&quot;George&quot;</span>, <span class="number">1242</span>, <span class="number">3.8</span>)</span></span>;</span><br><span class="line">  <span class="function">Professor <span class="title">p3</span><span class="params">(<span class="string">&quot;Jane&quot;</span>, <span class="number">1019</span>, <span class="number">2</span>)</span></span>;</span><br><span class="line">  <span class="comment">/* These methods is callable on all Person/Student/Professor object */</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%s&#x27;s id: %d\n&quot;</span>, p1.get_name(), p1.get_id());</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%s&#x27;s id: %d\n&quot;</span>, p2.get_name(), p2.get_id());</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%s&#x27;s id: %d\n&quot;</span>, p3.get_name(), p3.get_id());</span><br><span class="line">  <span class="comment">/* Only callable on a Student object */</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%s&#x27;s GPA: %lf\n&quot;</span>, p2.get_name(), p2.get_gpa());</span><br><span class="line">  <span class="comment">/* Only callable on a Professor object */</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%s teaches %d courses\n&quot;</span>, p3.get_name(), p3.get_courses_taught());</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Public-Inheritance-and-Members-Visibility"><a href="#Public-Inheritance-and-Members-Visibility" class="headerlink" title="Public Inheritance and Members Visibility"></a>Public Inheritance and Members Visibility</h2></li>
<li><p>Public members of the base class visible in the derived class</p>
</li>
<li><p><em>Private</em> members of the base class <em>not</em> visible in the derived class</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span> &#123;</span></span><br><span class="line"><span class="keyword">private</span>: <span class="keyword">int</span> b;</span><br><span class="line"><span class="keyword">public</span>: <span class="keyword">int</span> a;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">f1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;f1 called\n&quot;</span>);</span><br><span class="line">        a = <span class="number">10</span>;  <span class="comment">// working</span></span><br><span class="line">        b = <span class="number">10</span>;  <span class="comment">// working</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Derived</span> :</span> <span class="keyword">public</span> Base &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">f2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;f2 called\n&quot;</span>);</span><br><span class="line">        f1();    <span class="comment">// working</span></span><br><span class="line">        a = <span class="number">12</span>;  <span class="comment">// working</span></span><br><span class="line">        <span class="comment">// b = 12;  // can&#x27;t do that,</span></span><br><span class="line">                    <span class="comment">// b is not visible， because it&#x27;s private</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h1 id="Polymorphism-in-C"><a href="#Polymorphism-in-C" class="headerlink" title="Polymorphism in C++"></a>Polymorphism in C++</h1></li>
<li><p>Having several implementations for a function with a given name</p>
</li>
<li><p>Polymorphism</p>
<ul>
<li>Function overloading <em>compile-time polymorphism</em>  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// multiple implementation of the function print, differing in types and number of arguments</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;an int: %d\n&quot;</span>, x);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">(<span class="keyword">char</span> c)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;a char: %c\n&quot;</span>, c);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">(<span class="keyword">double</span> d1, <span class="keyword">double</span> d2)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;a couple of doubles:&quot;</span></span><br><span class="line">        <span class="string">&quot;%lf and %lf\n&quot;</span>, d1, d2);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    print(<span class="number">1</span>);</span><br><span class="line">    print(<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line">    print(<span class="number">5.5</span>, <span class="number">1.2</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>A more complex example<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> &#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">char</span> _name[<span class="number">128</span>];</span><br><span class="line">    <span class="keyword">int</span> _id;</span><br><span class="line">    <span class="keyword">char</span> _postcode[<span class="number">7</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    Person(<span class="keyword">const</span> <span class="keyword">char</span> *name);</span><br><span class="line">    Person(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">int</span> id);</span><br><span class="line">    Person(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">const</span> <span class="keyword">char</span> *postcode);</span><br><span class="line">    Person(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">int</span> id, <span class="keyword">const</span> <span class="keyword">char</span> *postcode);</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Person::Person(<span class="keyword">const</span> <span class="keyword">char</span> *name) &#123;</span><br><span class="line">    <span class="built_in">strcpy</span>(_name, name);</span><br><span class="line">    _id = <span class="number">0</span>;</span><br><span class="line">    _postcode[<span class="number">0</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Person::Person(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">int</span> id) &#123;</span><br><span class="line">    <span class="built_in">strcpy</span>(_name, name);</span><br><span class="line">    _id = id;</span><br><span class="line">    _postcode[<span class="number">0</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Person::Person(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">const</span> <span class="keyword">char</span> *postcode) &#123;</span><br><span class="line">    <span class="built_in">strcpy</span>(_name, name);</span><br><span class="line">    _id = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">strcpy</span>(_postcode, postcode);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Person::Person(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">int</span> id, <span class="keyword">const</span> <span class="keyword">char</span> *postcode) &#123;</span><br><span class="line">    <span class="built_in">strcpy</span>(_name, name);</span><br><span class="line">    _id = id;</span><br><span class="line">    <span class="built_in">strcpy</span>(_postcode, postcode);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Person::print</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;name: %s, id: %d, postcode: %s\n&quot;</span>, _name, _id, _postcode);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="function">Person <span class="title">p1</span><span class="params">(<span class="string">&quot;James&quot;</span>)</span></span>;</span><br><span class="line">    <span class="function">Person <span class="title">p2</span><span class="params">(<span class="string">&quot;Jane&quot;</span>, <span class="number">1234</span>)</span></span>;</span><br><span class="line">    <span class="function">Person <span class="title">p3</span><span class="params">(<span class="string">&quot;George&quot;</span>, <span class="string">&quot;M139PL&quot;</span>)</span></span>;</span><br><span class="line">    <span class="function">Person <span class="title">p4</span><span class="params">(<span class="string">&quot;Julie&quot;</span>, <span class="number">1235</span>, <span class="string">&quot;M188HN&quot;</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    p1.print();<span class="comment">//name: James, id: 0, postcode: </span></span><br><span class="line">    p2.print();<span class="comment">//name: Jane, id: 1234, postcode: </span></span><br><span class="line">    p3.print();<span class="comment">//name: George, id: 0, postcode: M139PL</span></span><br><span class="line">    p4.print();<span class="comment">//name: Julie, id: 1235, postcode: M188HN</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li> Function overriding <em>Runtime polymorphism</em><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Derived</span> :</span> <span class="keyword">public</span> Base &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">()</span></span>; <span class="comment">// overrides f from Base class</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Base::f</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Base&#x27;s f() called\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Derived::f</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Derived&#x27;s f() called\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    Base b;</span><br><span class="line">    Derived d;</span><br><span class="line">    Base *base_ptr = &amp;d;</span><br><span class="line"></span><br><span class="line">    b.f(); <span class="comment">// base f called</span></span><br><span class="line">    d.f(); <span class="comment">// derived f called</span></span><br><span class="line">    base_ptr-&gt;f(); <span class="comment">// compiler sees that base_ptr is of the type Base * so !Base&#x27;s f() is called!</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Virtual-Function-Overriding"><a href="#Virtual-Function-Overriding" class="headerlink" title="Virtual Function Overriding"></a>Virtual Function Overriding</h2></li>
</ul>
</li>
<li><p>A virtual function is a member function which is declared within a base class and is re-defined (overridden) by a derived class. When you refer to a derived class object using a pointer or a reference to the base class, you can call a virtual function for that object and execute the derived class’s version of the function. By <a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/virtual-function-cpp/">GeeksforGeeks</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">f</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Derived</span> :</span> <span class="keyword">public</span> Base &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Base::f</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Base&#x27;s f() called\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Derived::f</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Derived&#x27;s f() called\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">call_f</span><span class="params">(Base *b)</span> </span>&#123;</span><br><span class="line">    b-&gt;f();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    Base b;</span><br><span class="line">    Derived d;</span><br><span class="line"></span><br><span class="line">    call_f(&amp;b);   <span class="comment">// Base f() called</span></span><br><span class="line">    call_f(&amp;d);   <span class="comment">// Derive f() called</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Abstract-Classes"><a href="#Abstract-Classes" class="headerlink" title="Abstract Classes"></a>Abstract Classes</h2></li>
<li><p>A class with a least one pure virtual function is named an abstract class</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Class C &#123;</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">pure_virtual_function</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>Cannot be instantiated</p>
</li>
<li><p>Requires all derived classes to override all pure virtual functions</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sleep</span><span class="params">()</span></span>; <span class="comment">// all animals sleep similarly</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">sound</span><span class="params">()</span> </span>= <span class="number">0</span>; <span class="comment">// all animals make noise, but different noises</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span> :</span> <span class="keyword">public</span> Animal &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sound</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cat</span> :</span> <span class="keyword">public</span> Animal &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sound</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Animal::sleep</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;zzzzz\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Dog::sound</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;woof\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Cat::sound</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;meow\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    Dog d;</span><br><span class="line">    Cat c;</span><br><span class="line"></span><br><span class="line">    d.sound(); <span class="comment">// woof</span></span><br><span class="line">    d.sleep(); <span class="comment">// zzzzz</span></span><br><span class="line">    c.sound(); <span class="comment">// meow</span></span><br><span class="line">    c.sleep(); <span class="comment">// zzzzz</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="The-Preprocessor"><a href="#The-Preprocessor" class="headerlink" title="The Preprocessor"></a>The Preprocessor</h1></li>
<li><p><code>gcc src.c -o prog</code></p>
</li>
<li><p><code>src.c</code>(source file) -preprocessor-&gt; <code>src-tmp.c</code> (Preprocesses Source) -compiler-&gt; <code>prog</code>(executable program)</p>
</li>
<li><p>Run by the C/C++ compiler transparently 透明地</p>
</li>
<li><p>Performs textual transformations in the sources</p>
<ul>
<li>Include headers to access functions, structures, classes, and other definition from other source files</li>
<li>Expand tokens named macros into more complex bits of code</li>
<li>Conditionally enable/disable some bits of code<h2 id="Header-Inclusion"><a href="#Header-Inclusion" class="headerlink" title="Header Inclusion"></a>Header Inclusion</h2></li>
</ul>
</li>
<li><p>Header files: source file with .h extension, contain what is necessary to use foreign libraries/source files</p>
<ul>
<li>Headers should contain only <em>declarations</em>: functions prototypes, variables/custom types/structs/C++ classes declaration</li>
<li>No implementation!<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// In the .c source file, include headers like that:</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;            // Use &lt;&gt; to include a file from the default include path</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;my-custom-header.h&quot;</span> <span class="comment">// Use &quot;&quot; for the local and user-supplied include directories</span></span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>Can use <code>whereis stdio.h</code> to find location of <code>stdio.h</code></p>
<h2 id="Macro-Expansions"><a href="#Macro-Expansions" class="headerlink" title="Macro Expansions"></a>Macro Expansions</h2></li>
<li><p>Textual substitutions, useful for compile-time defined constants</p>
<ul>
<li>Generally indicated in capital letters as a convention</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="comment">// If we want to change the array size,</span></span><br><span class="line"><span class="comment">// we only need to update this:</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ARRAY_SIZE  10</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> <span class="built_in">array</span>[ARRAY_SIZE];</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;ARRAY_SIZE; i++) &#123;</span><br><span class="line">    <span class="built_in">array</span>[i] = i;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;array[%d] = %d\n&quot;</span>, i, <span class="built_in">array</span>[i]);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>In general, try to have a less hardcoded values as possible<ul>
<li>When you see that you are writing a constant value more then once, check if <em>using a macro</em> is possible!</li>
<li>Even if you have a constant used only once a macro can make it look more meaningful</li>
</ul>
</li>
<li>Macros can also be used to write macro “functions”<ul>
<li>Can be error-prone易出错, see here: <a target="_blank" rel="noopener" href="https://bit.ly/3EaQ2DA">https://bit.ly/3EaQ2DA</a></li>
</ul>
</li>
<li>Be careful with operator precedence! Use parentheses<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SIZE_1  10</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SIZE_2  10</span></span><br><span class="line"><span class="comment">// We can use a macro in another macro&#x27;s definiiton:</span></span><br><span class="line"><span class="comment">// More than 1 macro in another macro&#x27;s definition? use parentheses</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TOTAL   (SIZE_1 + SIZE_2)</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// correct, expands to:</span></span><br><span class="line">    <span class="comment">// (10 + 10) * 2</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;total twice = %d\n&quot;</span>,</span><br><span class="line">            TOTAL * <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Modular-Compilation"><a href="#Modular-Compilation" class="headerlink" title="Modular Compilation"></a>Modular Compilation</h1></li>
<li>Large programs: need to organise the code in several source files<ul>
<li>Linux kernel sources (52K source files!)</li>
</ul>
</li>
<li>Modular compilation can break up the program code into different files representing well isolated compilation units?</li>
<li>Also, can’t run gcc &lt;52K source files&gt; each time we do a small update to one or a few source files</li>
<li>Automated compilation can automate efficiently the build process<h2 id="Compilation-Phase"><a href="#Compilation-Phase" class="headerlink" title="Compilation Phase"></a>Compilation Phase</h2></li>
<li><code>gcc -c src.c -o src.o</code>, <code>gcc src.o -o prog</code></li>
<li><code>src.c</code>(source file) (text) -compiler-&gt; <code>src.o</code> (Object file)(binary, non-executable) -linker-&gt; <code>prog</code>(executable program) (binary, executable)<h2 id="Breaking-down-the-program-into-modules"><a href="#Breaking-down-the-program-into-modules" class="headerlink" title="Breaking down the program into modules"></a>Breaking down the program into modules</h2></li>
<li>Hypothetical假设 example of a server application implemented into 3 .c source files, also named modules:<br><img src="https://olivierpierre.github.io/comp26020/slides/19-modular-compilation/include/modular1.svg" alt="breaking example"><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gcc -c network.c -o network.o</span><br><span class="line">gcc -c parser.c -o parser.o</span><br><span class="line">gcc -c main.c -o main.o</span><br><span class="line">gcc main.o network.o parser.o -o prog</span><br></pre></td></tr></table></figure></li>
<li>Each module (.c source file) exposes公开 an interface callable from the other source files<ul>
<li>Should be as <em>small</em> as possible to hide internal code/data<ul>
<li>Same principle as for C++ classes public/private member functions/variables</li>
</ul>
</li>
</ul>
</li>
<li>Assume the following interactions:<br><img src="https://olivierpierre.github.io/comp26020/slides/19-modular-compilation/include/modular2.svg" alt="interaction"><h2 id="Header-File-for-Modular-Compilation"><a href="#Header-File-for-Modular-Compilation" class="headerlink" title="Header File for Modular Compilation"></a>Header File for Modular Compilation</h2></li>
<li>There is generally 1 header file per module, defining its interface.</li>
<li>Can be included in several .c files so must contain only declarations<ul>
<li>Function prototypes, struct/typedefs/enums declarations, variable declarations</li>
<li>No definitions (i.e. function body/global variable initialisation)</li>
</ul>
</li>
<li>For example network.h:<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> NETWORK_H <span class="comment">// include guard</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NETWORK_H</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">char</span> content[<span class="number">128</span>];</span><br><span class="line">&#125; request; <span class="comment">// only declarations</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_network</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rcv_request</span><span class="params">(request *r)</span></span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* NETWORK_H */</span></span></span><br></pre></td></tr></table></figure></li>
<li>in network.c:<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* std includes here */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;network.h&quot;</span></span></span><br><span class="line"><span class="comment">// this function and variable are internal</span></span><br><span class="line"><span class="comment">// so they are not declared in network.h</span></span><br><span class="line"><span class="comment">// the keyword static force their use</span></span><br><span class="line"><span class="comment">// to be only within the network.c file</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">generate_request</span><span class="params">(request *r)</span></span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> request_counter = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_network</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* init code here ... */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rcv_request</span><span class="params">(request *r)</span> </span>&#123;</span><br><span class="line">    generate_request(r);</span><br><span class="line">    <span class="comment">/* ... */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">generate_request</span><span class="params">(request *r)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* ... */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>in parser.h<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> PARSER_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PARSER_H</span></span><br><span class="line"><span class="comment">/* needed for the definition of request: */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;network.h&quot;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">parse_req</span><span class="params">(request *r)</span></span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure></li>
<li>in parser.c<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;parser.h&quot;</span></span></span><br><span class="line"><span class="comment">/* These two function are internal and their prototype is not in the header */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">internal1</span><span class="params">(request *r)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">internal2</span><span class="params">(request *r)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">parse_req</span><span class="params">(request *r)</span> </span>&#123;</span><br><span class="line">    internal1(r);</span><br><span class="line">    internal2(r);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">internal1</span><span class="params">(request *r)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* ... */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">internal2</span><span class="params">(request *r)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* ... */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>in main.c<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;network.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;parser.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    request req;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[main] calling init_network()\n&quot;</span>);</span><br><span class="line">    init_network();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[main] calling rcv_request()\n&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(rcv_request(&amp;req) != <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[main] calling parse_req()\n&quot;</span>);</span><br><span class="line">        parse_req(&amp;req);</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[main] exiting now\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="C-Source-Management"><a href="#C-Source-Management" class="headerlink" title="C++ Source Management"></a>C++ Source Management</h2></li>
<li>Common practice to divide the source code of a C++ program into multiple files as follows:<ul>
<li>one .h file per class or groups of related classes, containing <em>class declarations</em></li>
<li>one .cpp file per class or group of related classes, containing <em>member functions implementations</em><h1 id="Automated-Compilation"><a href="#Automated-Compilation" class="headerlink" title="Automated Compilation"></a>Automated Compilation</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># Initial build:</span><br><span class="line">gcc -c network.c -o network.o</span><br><span class="line">gcc -c parser.c -o parser.o</span><br><span class="line">gcc -c main.c -o main.o</span><br><span class="line">gcc main.o network.o parser.o -o prog</span><br><span class="line"># Assume we updated parser.c, to rebuild, we don&#39;t need to recompile everything:</span><br><span class="line">gcc -c parser.c -o parser.o</span><br><span class="line">gcc main.o network.o parser.o -o prog</span><br><span class="line"># Now we updated parser.h, remember it&#39;s included in both parser.c and main.c, so:</span><br><span class="line">gcc -c parser.c -o parser.o</span><br><span class="line">gcc -c main.c -o main.o</span><br><span class="line">gcc main.o network.o parser.o -o prog</span><br></pre></td></tr></table></figure>
<h2 id="Makefiles-Automated-Build-and-Dependency-Management"><a href="#Makefiles-Automated-Build-and-Dependency-Management" class="headerlink" title="Makefiles: Automated Build and Dependency Management"></a>Makefiles: Automated Build and Dependency Management</h2></li>
</ul>
</li>
<li>Let’s consider the dependencies in our example program<br><img src="https://olivierpierre.github.io/comp26020/slides/20-automated-compilation/include/deps1.svg" alt="makefile1"><br><img src="https://olivierpierre.github.io/comp26020/slides/20-automated-compilation/include/deps2.svg" alt="makefile2"></li>
<li>Text file named <code>Makefile</code> in the local source directory<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># The first rule is executed when the</span><br><span class="line"># command make is typed in the local folder:</span><br><span class="line">all: prog</span><br><span class="line"># executable deps and command to buil1d it:</span><br><span class="line">prog: main.o network.o parser.o</span><br><span class="line">    gcc main.o network.o parser.o -o prog</span><br><span class="line"># network.o deps and command to build it:</span><br><span class="line">network.o: network.c network.h</span><br><span class="line">    gcc -c network.c -o network.o</span><br><span class="line">parser.o: parser.c parser.h network.h</span><br><span class="line">    gcc -c parser.c -o parser.o</span><br><span class="line">main.o: main.c network.h parser.h</span><br><span class="line">    gcc -c main.c -o main.o</span><br><span class="line"># Special rule to remove all build files</span><br><span class="line">clean:</span><br><span class="line">    rm -rf *.o prog</span><br></pre></td></tr></table></figure></li>
<li>Rule Syntax:<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;target&gt;: &lt;dependencies&gt;</span><br><span class="line">[TAB]   &lt;command to build target from deps&gt;</span><br></pre></td></tr></table></figure></li>
<li>Use make file<ul>
<li>Type <code>make</code> in terminal<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gcc -c main.c -o main.o</span><br><span class="line">gcc -c network.c -o network.o</span><br><span class="line">gcc -c parser.c -o parser.o</span><br><span class="line">gcc main.o network.o parser.o -o prog</span><br></pre></td></tr></table></figure></li>
<li>Type <code>touch network.c</code> in terminal to update network.c, then <code>make</code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -c network.c -o network.o</span><br><span class="line">gcc main.o network.o parser.o -o prog</span><br></pre></td></tr></table></figure></li>
<li>Type <code>make clean</code> to remove all build files<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm -rf *.o prog</span><br></pre></td></tr></table></figure>
<h1 id="Type-Conversion-and-Casting"><a href="#Type-Conversion-and-Casting" class="headerlink" title="Type Conversion and Casting"></a>Type Conversion and Casting</h1><h2 id="Implicit-Type-Conversions"><a href="#Implicit-Type-Conversions" class="headerlink" title="Implicit Type Conversions"></a>Implicit Type Conversions</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">char</span> char_var = <span class="number">12</span>;   <span class="comment">// 1 byte, -128 -to 127</span></span><br><span class="line">  <span class="keyword">int</span> int_var = <span class="number">1000</span>;   <span class="comment">// 4 bytes, -2*10^9 to 2*10^9</span></span><br><span class="line">  <span class="keyword">long</span> <span class="keyword">long</span> ll_var = <span class="number">0x840A1231AC154</span>; <span class="comment">// 8 bytes, -9*10^18 to 9*10^18</span></span><br><span class="line">  <span class="comment">// here, char_var is first promoted to int, then the result of the first</span></span><br><span class="line">  <span class="comment">// addition is promoted to long long</span></span><br><span class="line">  <span class="keyword">long</span> <span class="keyword">long</span> result = (char_var + int_var) + ll_var;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%lld\n&quot;</span>, result); <span class="comment">//2322860636554568</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Integer-Promotion"><a href="#Integer-Promotion" class="headerlink" title="Integer Promotion"></a>Integer Promotion</h2><img src="https://olivierpierre.github.io/comp26020/slides/21-type-conversion-casting/include/integer-promotion.svg" alt="integer promotion"></li>
</ul>
</li>
</ul>
<ol>
<li>Same type? no promotion</li>
<li>Same signed/unsigned attribute? lesser rank promoted to greater rank</li>
<li>Unsigned rank &gt;= other operand rank? signed promoted to the unsigned rank</li>
<li>Signed type can represent all the values of the unsigned type? unsigned operand promoted to signed type</li>
<li>Otherwise, both operands converted to the unsigned type corresponding to the signed operand’s type<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> si = <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> ui = <span class="number">1</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, si &lt; ui); <span class="comment">// prints 0! si converted to unsigned int; 0 means false</span></span><br></pre></td></tr></table></figure></li>
</ol>
<ul>
<li>Always remember the storage sizes of types<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i = <span class="number">-1000</span>;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> ui = <span class="number">4294967295</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, i + ui); <span class="comment">// prints -1001</span></span><br><span class="line">  <span class="comment">//      i:   11111111111111111111110000011000 (A)</span></span><br><span class="line">  <span class="comment">//     ui:   11111111111111111111111111111111 (B)</span></span><br><span class="line">  <span class="comment">// i + ui:  111111111111111111111110000010111 (C)</span></span><br><span class="line">  <span class="comment">//  final:   11111111111111111111110000010111 (D)</span></span><br><span class="line">  <span class="comment">// (A) originally 2&#x27;s complement promoted to unsigned</span></span><br><span class="line">  <span class="comment">// (B) standard unsigned representation, max number an unsigned int can store</span></span><br><span class="line">  <span class="comment">// (C) addition result</span></span><br><span class="line">  <span class="comment">// (D) result overflows 32 bits as an int (expected by %d), loosing MSB</span></span><br><span class="line">  <span class="comment">// Solution: use %ld rather than %d to store the result on 64 bits</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Integer-to-Floating-Point-Conversion"><a href="#Integer-to-Floating-Point-Conversion" class="headerlink" title="Integer to Floating-Point Conversion"></a>Integer to Floating-Point Conversion</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//prints 7:  25/10 rounds to 2; 2 * 15 = 30; 30/4 rounds to 7</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, <span class="number">25</span> / <span class="number">10</span> * <span class="number">15</span> / <span class="number">4</span>);</span><br><span class="line">    <span class="comment">// prints 7.5: 25/10 rounds to 2; 2*15 = 30; 30 gets converted to</span></span><br><span class="line">    <span class="comment">// 30.0 (double) and divided by 4.0 (double) giving result 7.5 (double)</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%lf\n&quot;</span>, <span class="number">25</span> / <span class="number">10</span> * <span class="number">15</span> / <span class="number">4.0</span>);</span><br><span class="line">    <span class="comment">// prints 9.375: 25.0 / 10.0 (converted from 10) is 2.5, multiplied by 15.0</span></span><br><span class="line">    <span class="comment">// (converted from 15) gives 37.5, divided by 4.0 (converted from 4) gives</span></span><br><span class="line">    <span class="comment">// 9.375</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%lf\n&quot;</span>, <span class="number">25.0</span> / <span class="number">10</span> * <span class="number">15</span> / <span class="number">4</span>);</span><br><span class="line">    <span class="comment">// prints garbage, don&#x27;t try to interpret a double as an int!</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, <span class="number">25.0</span> / <span class="number">10</span> * <span class="number">15</span> / <span class="number">4</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Parameter-Passing"><a href="#Parameter-Passing" class="headerlink" title="Parameter Passing"></a>Parameter Passing</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f1</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, i);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f2</span><span class="params">(<span class="keyword">double</span> d)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%lf\n&quot;</span>, d);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f3</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> ui)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%u\n&quot;</span>, ui);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> c = <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> ull = <span class="number">0x400000000000</span>;</span><br><span class="line">    f1(c);    <span class="comment">// prints 97 (ascii code for &#x27;a&#x27;)</span></span><br><span class="line">    f2(c);    <span class="comment">// prints 97.0</span></span><br><span class="line">    f3(ull);  <span class="comment">// overflows int ... prints 0 (lower 32 bits of 0x400000000000)</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Type-Casting-类型铸造"><a href="#Type-Casting-类型铸造" class="headerlink" title="Type Casting 类型铸造"></a>Type Casting 类型铸造</h2></li>
<li>Casting allows to force the type of an expression</li>
<li>syntax: <code>(type)expression</code><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// prints 3.75: 3 gets converted to 3.7500</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%lf\n&quot;</span>, (<span class="keyword">float</span>)<span class="number">15</span>/<span class="number">4</span>);</span><br><span class="line"><span class="comment">// prints 4: 2.5 converted to 2 (int), multiplied by 12 gives 24, divided</span></span><br><span class="line"><span class="comment">// by 5 gives 4</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, ((<span class="keyword">int</span>)<span class="number">2.5</span> * <span class="number">12</span>)/<span class="number">5</span>);</span><br><span class="line"><span class="comment">// prints 4.8: 2*12 = 24, converted to 24.0, divided by 5.0 gives 4.8</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%lf\n&quot;</span>, ((<span class="keyword">int</span>)<span class="number">2.5</span> * <span class="number">12</span>)/(<span class="keyword">double</span>)<span class="number">5</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> si = <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> ui = <span class="number">1</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, si &lt; (<span class="keyword">int</span>)ui); <span class="comment">// prints 1</span></span><br></pre></td></tr></table></figure>
<h2 id="Generic-Pointers"><a href="#Generic-Pointers" class="headerlink" title="Generic Pointers"></a>Generic Pointers</h2></li>
<li>void * can be used as a generic pointer to pass data of different types<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">    CHAR,</span><br><span class="line">    INT,</span><br><span class="line">    DOUBLE</span><br><span class="line">&#125; type_enum;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">(<span class="keyword">void</span> *data, type_enum t)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span>(t) &#123;</span><br><span class="line">        <span class="keyword">case</span> CHAR:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;character: %c\n&quot;</span>, *(<span class="keyword">char</span> *)data);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> INT:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;integer: %d\n&quot;</span>, *(<span class="keyword">int</span> *)data);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> DOUBLE:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;double: %lf\n&quot;</span>, *(<span class="keyword">double</span> *)data);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Unknown type ...\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> c = <span class="string">&#x27;x&#x27;</span>;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">42</span>;</span><br><span class="line">    <span class="keyword">double</span> d = <span class="number">11.5</span>;</span><br><span class="line"></span><br><span class="line">    print((<span class="keyword">void</span> *)&amp;c, CHAR); <span class="comment">//character: x</span></span><br><span class="line">    print((<span class="keyword">void</span> *)&amp;i, INT); <span class="comment">//integer: 42</span></span><br><span class="line">    print((<span class="keyword">void</span> *)&amp;d, DOUBLE); <span class="comment">//double: 11.500000</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Debugging-with-GDB"><a href="#Debugging-with-GDB" class="headerlink" title="Debugging with GDB"></a>Debugging with GDB</h1></li>
<li>Compile with <code>-g</code> flag to include debug symbols</li>
<li>To launch gdb on a particular binary : <code>gdb program</code> in a shell</li>
<li><code>b test.c:12</code> places a breakpoint on the instruction at line 18 in test.c</li>
<li><code>b my_func</code> places a breakpoint on the first instruction of <code>my_func</code></li>
<li><code>b test.c:12 if x == 42</code> is a conditional breakpoint, will pop only if x is equal to 42 when the corresponding statement is executed</li>
<li><code>run</code> starts the program</li>
<li>In single-step mode:<ul>
<li><code>up</code> and <code>down</code> allows to navigate the function call stack</li>
<li><code>next</code> advances the execution, <em>jumping over</em> function calls</li>
<li><code>step</code> advances the execution, <em>diving into</em> function calls</li>
<li><code>continue</code> exits single step mode<h1 id="Case-study-HPC"><a href="#Case-study-HPC" class="headerlink" title="Case study: HPC"></a>Case study: HPC</h1></li>
</ul>
</li>
<li>C/C++ are extensively used in High Performance Computing (HPC) because of their speed</li>
<li>Due to many reasons, including the fact that they gives the programmer control over the data memory layout<h2 id="Controlling-Memory-Layout"><a href="#Controlling-Memory-Layout" class="headerlink" title="Controlling Memory Layout"></a>Controlling Memory Layout</h2><img src="https://olivierpierre.github.io/comp26020/slides/23-hpc-case-study/include/cache.svg" alt="memory example"></li>
<li>For performance reasons it is very important to fit as much of the data set as possible in the cache<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> c[<span class="number">60</span>];</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">double</span> d;</span><br><span class="line">&#125; my_struct;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> N 100000000</span></span><br><span class="line">my_struct <span class="built_in">array</span>[N];</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">start</span>, <span class="title">stop</span>, <span class="title">res</span>;</span></span><br><span class="line">    my_struct s;</span><br><span class="line">    gettimeofday(&amp;start, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">/* Randomly access N elements */</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++)</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;s, &amp;<span class="built_in">array</span>[rand()%N],</span><br><span class="line">            <span class="keyword">sizeof</span>(my_struct));</span><br><span class="line">    gettimeofday(&amp;stop, <span class="literal">NULL</span>);</span><br><span class="line">    timersub(&amp;stop, &amp;start, &amp;res);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%ld.%06ld\n&quot;</span>, res.tv_sec,</span><br><span class="line">        res.tv_usec); <span class="comment">// takes 14.896576s</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; &#125;</span><br></pre></td></tr></table></figure></li>
<li>Struct size: 60 + 4 (int) + 8 (double) = 72 bytes<ul>
<li>Larger and not a multiple of the cache line size (64 bytes)</li>
<li>Most objects in the array will require to fetch 2 cache lines from main memory <img src="https://olivierpierre.github.io/comp26020/slides/23-hpc-case-study/include/alignment.svg" alt="cacheLine"><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> c[<span class="number">52</span>]; <span class="comment">// down from 60, we have 52 + 4 + 8 == 64 bytes i.e. a cache line</span></span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">double</span> d;</span><br><span class="line">&#125; my_struct;</span><br><span class="line">my_struct <span class="built_in">array</span>[N] __attribute__ ((aligned(<span class="number">64</span>)));  <span class="comment">/* force alignment of the array itself */</span> <span class="comment">//takes 13.696097s</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>Should be 25% faster, mine is not so explicit because I’m using sandbox50<h1 id="Case-study-C-Standard-Library"><a href="#Case-study-C-Standard-Library" class="headerlink" title="Case study - C Standard Library"></a>Case study - C Standard Library</h1></li>
<li>Provides and implement all the functions from stdio.h, stdlib.h, etc.</li>
<li>C + a tiny bit of assembly</li>
<li>Default libc in most Linux distribution Glibc<ul>
<li>Complex and hard to study</li>
<li><a target="_blank" rel="noopener" href="https://www.gnu.org/software/libc/">https://www.gnu.org/software/libc/</a></li>
</ul>
</li>
<li>Simpler: Musl<ul>
<li><a target="_blank" rel="noopener" href="https://www.musl-libc.org/">https://www.musl-libc.org/</a><h2 id="Using-Musl-System-Calls"><a href="#Using-Musl-System-Calls" class="headerlink" title="Using Musl - System Calls"></a>Using Musl - System Calls</h2></li>
</ul>
</li>
<li>Application request services from the OS through system calls</li>
<li>Generally not made directly by user code but rather the libc</li>
<li>Upon syscall 在系统调用时: user/kernel “world switch”</li>
<li>System calls have a calling convention<ul>
<li>Machine instructions used to trigger a syscall</li>
</ul>
</li>
<li>On Intel x86-64, this convention is as follows:</li>
</ul>
<ol>
<li>Syscall number in %rax<ul>
<li>List here: <a target="_blank" rel="noopener" href="https://filippo.io/linux-syscall-table/">https://filippo.io/linux-syscall-table/</a></li>
</ul>
</li>
<li>Syscall parameters in order in %rsi, %rdx, %r10, %r8, and %r9</li>
<li>Execute the syscall instruction</li>
<li>Return value in %rax<h2 id="Musl’s-printf-Implementation"><a href="#Musl’s-printf-Implementation" class="headerlink" title="Musl’s printf Implementation"></a>Musl’s printf Implementation</h2><code>printf(&quot;value: %d %lf\n&quot;, int_val, double_val)</code>;</li>
</ol>
<ul>
<li>In src/stdio/printf.c:<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdarg.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">printf</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">restrict</span> fmt, ...)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    va_list ap;                       <span class="comment">// variable argument list management</span></span><br><span class="line">    va_start(ap, fmt);</span><br><span class="line">    ret = <span class="built_in">vfprintf</span>(<span class="built_in">stdout</span>, fmt, ap);  <span class="comment">// stdout: data structure representing the std output</span></span><br><span class="line">    va_end(ap);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>In src/stdio/vfprintf.c:<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* lots of logic for format string parsing ... */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">vfprintf</span><span class="params">(FILE *<span class="keyword">restrict</span> f, <span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">restrict</span> fmt, va_list ap)</span> </span>&#123;</span><br><span class="line"><span class="comment">/* ... */</span></span><br><span class="line">    ret = printf_core(f, fmt, &amp;ap2, nl_arg, nl_type);</span><br><span class="line"><span class="comment">/* ... */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">printf_core</span><span class="params">(FILE *f, <span class="keyword">const</span> <span class="keyword">char</span> *fmt, va_list *ap, <span class="comment">/* ... */</span>)</span> </span>&#123;</span><br><span class="line"><span class="comment">/* ... */</span></span><br><span class="line">    <span class="keyword">if</span> (f) out(f, a, l);</span><br><span class="line"><span class="comment">/* ... */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">out</span><span class="params">(FILE *f, <span class="keyword">const</span> <span class="keyword">char</span> *s, <span class="keyword">size_t</span> l)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">     <span class="keyword">if</span> (!(f-&gt;flags &amp; F_ERR)) __fwritex((<span class="keyword">void</span> *)s, l, f);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>All these transforms something like “hello: %d, %lf”, 12, 12.0” into “hello: 12, 12.00000”</li>
<li>In src/stdio/fwrite.c:<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">size_t</span> __fwritex(<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *<span class="keyword">restrict</span> s, <span class="keyword">size_t</span> l, FILE *<span class="keyword">restrict</span> f)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">/* ... */</span></span><br><span class="line">    <span class="keyword">size_t</span> n = f-&gt;write(f, s, i);   <span class="comment">/* this is actually a call to __stdout_write(f, s, i);</span></span><br><span class="line"><span class="comment">/* ... */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>In src/stdio/__stdout_write.c:<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">size_t</span> __stdout_write(FILE *f, <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *buf, <span class="keyword">size_t</span> len)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">winsize</span> <span class="title">wsz</span>;</span></span><br><span class="line">    f-&gt;write = __stdio_write;</span><br><span class="line">    <span class="keyword">if</span> (!(f-&gt;flags &amp; F_SVB) &amp;&amp; __syscall(SYS_ioctl, f-&gt;fd, TIOCGWINSZ, &amp;wsz))</span><br><span class="line">        f-&gt;lbf = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">return</span> __stdio_write(f, buf, len);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>In  src/stdio/__stdio_write.c:<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">size_t</span> __stdio_write(FILE *f, <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *buf, <span class="keyword">size_t</span> len)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">/* ... */</span></span><br><span class="line">    cnt = syscall(SYS_writev, f-&gt;fd, iov, iovcnt);</span><br><span class="line"><span class="comment">/* ... */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>In C, printing to the standard output corresponds to a write (or writev) syscall on a file descriptor representing the standard output]</li>
<li>In src/internal/syscall.h:<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ... */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __SYSCALL_NARGS_X(a,b,c,d,e,f,g,h,n,...) n</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __SYSCALL_NARGS(...) __SYSCALL_NARGS_X(__VA_ARGS__,7,6,5,4,3,2,1,0,)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __SYSCALL_CONCAT_X(a,b) a##b</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __SYSCALL_CONCAT(a,b) __SYSCALL_CONCAT_X(a,b)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __SYSCALL_DISP(b,...) __SYSCALL_CONCAT(b,__SYSCALL_NARGS(__VA_ARGS__))(__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __syscall(...) __SYSCALL_DISP(__syscall,__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> syscall(...) __syscall_ret(__syscall(__VA_ARGS__))</span></span><br><span class="line"><span class="comment">/* ... */</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; This is a set of macros that transforms &quot;syscall(SYS_writev, f-&gt;fd, iov, iovcnt); we saw</span><br><span class="line">&#x2F;&#x2F; earlier into:</span><br><span class="line">__syscall_3(SYS_writev, f-&gt;fd, iov, iovcount);</span><br></pre></td></tr></table></figure></li>
<li>We now reach the architecture-specific part, let’s look at the x86-64 code, in arch/x86_64/syscall_arch.h:<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">static __inline long __syscall3(long n, long a1, long a2, long a3) &#123;</span><br><span class="line">    unsigned long ret;</span><br><span class="line">    __asm__ __volatile__ (  &quot;syscall&quot; :  &#x2F;&#x2F; 5) the syscall instruction</span><br><span class="line">                            &quot;&#x3D;a&quot;(ret) :  &#x2F;&#x2F; 6) we&#39;ll get the return value in rax</span><br><span class="line">                            &quot;a&quot;(n),      &#x2F;&#x2F; 1) syscall number in rax</span><br><span class="line">                            &quot;D&quot;(a1),     &#x2F;&#x2F; 2) argument 1 in rdi</span><br><span class="line">                            &quot;S&quot;(a2),     &#x2F;&#x2F; 3) argument 2 in rsi</span><br><span class="line">                            &quot;d&quot;(a3) :    &#x2F;&#x2F; 4) argument 3 in rdx</span><br><span class="line">                            &quot;rcx&quot;, &quot;r11&quot;, &quot;memory&quot;);</span><br><span class="line">    return ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">401bae:    41 be 14 00 00 00        mov    $0x14,%r14d</span><br><span class="line"> ...</span><br><span class="line">  401beb:    48 63 7b 78              movslq 0x78(%rbx),%rdi</span><br><span class="line">  401bef:    49 63 d5                 movslq %r13d,%rdx</span><br><span class="line">  401bf2:    4c 89 f0                 mov    %r14,%rax</span><br><span class="line">  401bf5:    48 89 ee                 mov    %rbp,%rsi</span><br><span class="line">  401bf8:    0f 05                    syscall</span><br></pre></td></tr></table></figure>
<h2 id="Printing-Without-Libc"><a href="#Printing-Without-Libc" class="headerlink" title="Printing Without Libc"></a>Printing Without Libc</h2></li>
<li>Now that we know how to print on stdout, we can make a syscall directly from our program without involving libc<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;* Without libc the default entry point is _start *&#x2F;</span><br><span class="line">void _start() &#123;</span><br><span class="line">    unsigned long ret;</span><br><span class="line">    &#x2F;* write(1, &quot;hello!\n&quot;, 7); *&#x2F;</span><br><span class="line">    __asm__ __volatile(</span><br><span class="line">            &quot;syscall&quot; :            &#x2F;&#x2F; the syscall instruction</span><br><span class="line">            &quot;&#x3D;a&quot;(ret) :            &#x2F;&#x2F; we&#39;ll get the return value in rax</span><br><span class="line">            &quot;a&quot;(1),                &#x2F;&#x2F; syscall number (1 for write)</span><br><span class="line">            &quot;D&quot;(1),                &#x2F;&#x2F; argument1: file descriptor (1 for stdout)</span><br><span class="line">            &quot;S&quot;((long)&quot;hello!\n&quot;), &#x2F;&#x2F; argument2: char array to print</span><br><span class="line">            &quot;d&quot;(7) :               &#x2F;&#x2F; argument3: number of bytes to write</span><br><span class="line">            &quot;rcx&quot;, &quot;r11&quot;, &quot;memory&quot;);</span><br><span class="line">    &#x2F;* exit(0); *&#x2F;</span><br><span class="line">    __asm__ __volatile( &quot;syscall&quot; : :  &#x2F;&#x2F; syscall instruction</span><br><span class="line">            &quot;a&quot;(60),                   &#x2F;&#x2F; exit&#39;s syscall number</span><br><span class="line">            &quot;D&quot;(0) :                   &#x2F;&#x2F; exit parameter: 0</span><br><span class="line">            &quot;rcx&quot;, &quot;r11&quot;, &quot;memory&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">0000000000001000 &lt;_start&gt;:</span><br><span class="line">    1000:    55                       push   %rbp</span><br><span class="line">    1001:    48 89 e5                 mov    %rsp,%rbp</span><br><span class="line">    1004:    48 8d 35 f5 0f 00 00     lea    0xff5(%rip),%rsi # argument 2, address of &quot;hello!&quot;</span><br><span class="line">    100b:    b8 01 00 00 00           mov    $0x1,%eax   # syscall number, 1 &#x3D;&#x3D; write</span><br><span class="line">    1010:    bf 01 00 00 00           mov    $0x1,%edi   # argument 1, fd 1 &#x3D;&#x3D; stdout</span><br><span class="line">    1015:    ba 07 00 00 00           mov    $0x7,%edx   # argument 3, 7 bytes to write</span><br><span class="line">    101a:    0f 05                    syscall</span><br><span class="line">    101c:    48 89 45 f8              mov    %rax,-0x8(%rbp)</span><br><span class="line">    1020:    b8 3c 00 00 00           mov    $0x3c,%eax # syscall number, 60 &#x3D;&#x3D; exit</span><br><span class="line">    1025:    ba 00 00 00 00           mov    $0x0,%edx  # argument 1: 0</span><br><span class="line">    102a:    89 d7                    mov    %edx,%edi</span><br><span class="line">    102c:    0f 05                    syscall</span><br><span class="line">    102e:    90                       nop</span><br><span class="line">    102f:    5d                       pop    %rbp</span><br><span class="line">    1030:    c3                       retq</span><br></pre></td></tr></table></figure>
<h1 id="Case-Study-OS-Kernel"><a href="#Case-Study-OS-Kernel" class="headerlink" title="Case Study - OS Kernel"></a>Case Study - OS Kernel</h1></li>
<li>C is the default language to write OS kernels<h2 id="System-Calls-in-a-Nutshell"><a href="#System-Calls-in-a-Nutshell" class="headerlink" title="System Calls in a Nutshell"></a>System Calls in a Nutshell</h2></li>
</ul>
<ol>
<li>Stack pointer (in CPU) -&gt; Task stack (in Memory)<br>lnstr.pointer (in CPU) -&gt; Task code (in Memory)</li>
<li>Stack pointer (in CPU) -&gt; Kernel stack (in Memory)<br>lnstr.pointer (in CPU) -&gt; Kernel code (in Memory)</li>
<li>CPU push all registers to Kernel stack</li>
<li>Kernel stack pop all registers to CPU</li>
<li>Stack pointer (in CPU) -&gt; Task stack (in Memory)<br>lnstr.pointer (in CPU) -&gt; Task code (in Memory)<h2 id="Context-Switches-in-a-Nutshell"><a href="#Context-Switches-in-a-Nutshell" class="headerlink" title="Context Switches in a Nutshell"></a>Context Switches in a Nutshell</h2></li>
<li>Stack pointer (in CPU) -&gt; Task A’s stack (in Memory)<br>lnstr.pointer (in CPU) -&gt; Task A’s code (in Memory)</li>
<li>Stack pointer (in CPU) -&gt; Task A’s Kernel stack (in Memory)<br>lnstr.pointer (in CPU) -&gt; Kernel code (in Memory)</li>
<li>CPU push all registers to Task A’s Kernel stack</li>
<li>Task B’s Kernel stack pop all registers to CPU</li>
<li>Stack pointer (in CPU) -&gt; Task B’s Kernel stack (in Memory)<br>lnstr.pointer (in CPU) -&gt; Kernel code (in Memory)</li>
<li>Stack pointer (in CPU) -&gt; Task B’s stack (in Memory)<br>lnstr.pointer (in CPU) -&gt; Task B’s  code (in Memory)<h2 id="System-Call-and-Context-Switch-Implementations-in-a-Real-OS"><a href="#System-Call-and-Context-Switch-Implementations-in-a-Real-OS" class="headerlink" title="System Call and Context Switch Implementations in a Real OS"></a>System Call and Context Switch Implementations in a Real OS</h2></li>
</ol>
<ul>
<li>HermiTux<ul>
<li>Very small OS for cloud applications<ul>
<li>Originally based on HermitCore (<a target="_blank" rel="noopener" href="https://github.com/hermitcore/libhermit">https://github.com/hermitcore/libhermit</a>)</li>
<li>~10K lines of C code and a bit of assembly, great to study and learn about OSes</li>
<li><a target="_blank" rel="noopener" href="https://github.com/ssrg-vt/hermitux">https://github.com/ssrg-vt/hermitux</a> </li>
</ul>
</li>
</ul>
</li>
<li>Context switch &amp; syscall handling can only be done by the kernel</li>
<li>The only way to enter the kernel is through an interrupt:</li>
<li>Interrupt traps to the kernel which saves the state of the interrupted task for resuming properly later. Interrupt traps(保存状态)-enter kernel -恢复使用</li>
<li>Example with sched_yield syscall (syscall + context switch):<img src="https://olivierpierre.github.io/comp26020/slides/25-os-kernel-case-study/include/timeline.svg" alt="sched_yield"></li>
<li>Syscall entry point is in arch/x86/kernel/entry.asm:<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">isyscall:</span><br><span class="line">    cli          ; disable interrupts</span><br><span class="line">    push rax     ; start pushing the task state on the stack</span><br><span class="line">    push rcx</span><br><span class="line">    ; ...        push many other registers</span><br><span class="line">    mov rdi, rsp ; prepare a datastructure containing register values for use by the kernel</span><br><span class="line">    sti          ; enable interrupts</span><br><span class="line">    call syscall_handler  ; jump to kernel (C) code managing the syscall</span><br></pre></td></tr></table></figure></li>
<li>syscall_handler is in arch/x86/kernel/isrs.c:<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">syscall_handler</span><span class="params">(struct state *s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span>(s-&gt;rax) &#123;</span><br><span class="line">        <span class="comment">// ... one &quot;case&quot; for each syscall number</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">24</span>:                            <span class="comment">// sched_yield&#x27;s number is 24</span></span><br><span class="line">            s-&gt;rax = sys_sched_yield();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">/* ... */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>sys_sched_yield (in kernel/syscalls/sched_yield) simply calls check_scheduling, in kernel/tasks.c:<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">check_scheduling</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* ... */</span></span><br><span class="line">    <span class="keyword">uint32_t</span> prio = get_highest_priority();</span><br><span class="line">    <span class="keyword">task_t</span>* curr_task = per_core(current_task);</span><br><span class="line">    <span class="keyword">if</span> (prio &gt; curr_task-&gt;prio) &#123;</span><br><span class="line">       reschedule();</span><br><span class="line">    <span class="comment">/* ... */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>Finally, reschedule calls switch_context (in kernel/tasks.c)</li>
<li>switch_context is in arch/x86/kernel/entry.asm:<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">switch_context:</span><br><span class="line">    push rax ; ... start pushing the state of the scheduled out task on the stack</span><br><span class="line">    push rcx</span><br><span class="line">    push rdx</span><br><span class="line">    ; ...</span><br><span class="line">    jmp common_switch</span><br><span class="line">    ; ...</span><br><span class="line">common_switch:</span><br><span class="line">    ; ...</span><br><span class="line">    call get_current_stack     ; get new rsp</span><br><span class="line">    mov rsp, rax               ; switch stack to the new task&#39;s one</span><br><span class="line">    ; ...</span><br><span class="line">    pop r15                    ; start restoring the scheduled in task state (reverse order)</span><br><span class="line">    pop r14</span><br><span class="line">    ; ...</span><br><span class="line">    add rsp, 16 ; at that point the stack pointer points to the saved instruction pointer</span><br><span class="line">    iretq ; restore instruction pointer from the stack, i.e. jumps there</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li>Executes return path in the kernel until we reach the kernel/user boundary<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">isyscall:</span><br><span class="line">    ; ...</span><br><span class="line">    call syscall_handler</span><br><span class="line">    ; ...</span><br><span class="line">    pop r15   ; start restoring the userland state of the task</span><br><span class="line">    pop r14</span><br><span class="line">    pop r13</span><br><span class="line">    ; ...</span><br><span class="line">    sysret    ; return from syscall handler to userspace</span><br></pre></td></tr></table></figure>
<h1 id="Memory-Unsafety"><a href="#Memory-Unsafety" class="headerlink" title="Memory Unsafety"></a>Memory Unsafety</h1></li>
<li>C/C++ are inherently天生的 memory unsafe</li>
<li>There is absolutely no check at runtime if memory accesses is initialised, allocated, or mapped</li>
<li>Generally the compiler won’t warn you either</li>
<li>A few examples of memory errors<ul>
<li>Out of band accesses on buffers/arrays accesses</li>
<li>Failure to initialise before read stack/heap allocated variables</li>
<li>Leaks, double free, use-after-free</li>
</ul>
</li>
<li>Memory errors are hard to detect, hard to debug<ul>
<li>No compiler/runtime warning</li>
<li>Undefined behaviour: sometimes it crashes, sometimes not…<h2 id="Example-1-Infoleak"><a href="#Example-1-Infoleak" class="headerlink" title="Example 1: Infoleak"></a>Example 1: Infoleak</h2>Original code:<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// char *welcome_message = &quot;Hi there! How is it going?\n&quot;; // 27 char</span></span><br><span class="line"><span class="comment">// the it&#x27;s updated to a shortened welcome message, only 11 chars now</span></span><br><span class="line"><span class="keyword">char</span> *welcome_message = <span class="string">&quot;Hi there!\n&quot;</span>; </span><br><span class="line"><span class="keyword">char</span> *password = <span class="string">&quot;secret&quot;</span>;</span><br><span class="line"><span class="keyword">char</span> entered_password[<span class="number">128</span>];</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Print welcome message character by character</span></span><br><span class="line"><span class="comment">// but the loop is still 27!!</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">27</span>; i++)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, welcome_message[i]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Please input the password:\n&quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, entered_password);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">strcmp</span>(entered_password, password)) &#123; <span class="built_in">printf</span>(<span class="string">&quot;Passowrd ok!\n&quot;</span>); <span class="comment">/* ... */</span> &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123; <span class="built_in">printf</span>(<span class="string">&quot;Wrong password! aborting\n&quot;</span>); &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>It read overflows welcome message, and password leaks to stdout!<h2 id="Example-2”-Sensitive-Data-Tampering"><a href="#Example-2”-Sensitive-Data-Tampering" class="headerlink" title="Example 2” Sensitive Data Tampering"></a>Example 2” Sensitive Data Tampering</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> user_input[<span class="number">32</span>] = <span class="string">&quot;0000000000&quot;</span>;</span><br><span class="line"><span class="keyword">char</span> password[<span class="number">32</span>] = <span class="string">&quot;secret&quot;</span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(argc != <span class="number">2</span>) &#123; <span class="built_in">printf</span>(<span class="string">&quot;Usage: %s &lt;password&gt;\n&quot;</span>, argv[<span class="number">0</span>]); <span class="keyword">return</span> <span class="number">0</span>; &#125;</span><br><span class="line">    <span class="built_in">strcpy</span>(user_input, argv[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">strncmp</span>(password, user_input, <span class="built_in">strlen</span>(password))) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;login success!\n&quot;</span>);</span><br><span class="line">        <span class="comment">/* do important stuff  ... */</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;wrong password!\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>If user_input is write overflows, in “strcmp”, strings are equal so password will be accepted<h2 id="Example-3-Stack-Smashing"><a href="#Example-3-Stack-Smashing" class="headerlink" title="Example 3: Stack Smashing"></a>Example 3: Stack Smashing</h2></li>
<li>Classic control flow hijacking劫持 attack</li>
<li>Originally proposed in 1996 here: <a target="_blank" rel="noopener" href="http://www.phrack.org/archives/issues/49/14.txt">http://www.phrack.org/archives/issues/49/14.txt</a></li>
<li>See how the CPU manage function calls/returns</li>
</ul>
<ol>
<li>The machine push return address on the stack and jump to the function</li>
<li>CPU pops return address from the stack and jumps to the end of calling function line<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> *password = <span class="string">&quot;super-secret-password&quot;</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">security_critical_function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;launching nukes!!\n&quot;</span>); <span class="comment">//发射核武器</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">preprocess_input</span><span class="params">(<span class="keyword">char</span> *<span class="built_in">string</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> local_buffer[<span class="number">16</span>];</span><br><span class="line">    <span class="built_in">strcpy</span>(local_buffer, <span class="built_in">string</span>);</span><br><span class="line">    <span class="comment">/* work on local buffer ... */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">2</span>) &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line">    preprocess_input(argv[<span class="number">1</span>]); <span class="comment">// This line makes mistake</span></span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">strncmp</span>(password, argv[<span class="number">1</span>],</span><br><span class="line">            <span class="built_in">strlen</span>(password)))</span><br><span class="line">        security_critical_function();</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Unauthorised user!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>Stack layout memory when preprocess_input runs</li>
<li>Overflow local_buffer and rewrite the return address</li>
<li>Then the return -&gt; CPU jumps to security_critical_function()!<h2 id="Example-4-Use-After-Free"><a href="#Example-4-Use-After-Free" class="headerlink" title="Example 4: Use-After-Free"></a>Example 4: Use-After-Free</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> member1;</span><br><span class="line">    <span class="keyword">void</span> (*member2)(<span class="keyword">int</span>);</span><br><span class="line">&#125; my_struct;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_hello</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Hello, parameter: %d\n&quot;</span>, x);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">security_critical_function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Auto destruction engaged!\n&quot;</span>);</span><br><span class="line">    <span class="comment">/* ... */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* allocate and init ms */</span></span><br><span class="line">    my_struct *ms = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(my_struct));</span><br><span class="line">    ms-&gt;member1 = <span class="number">42</span>;</span><br><span class="line">    ms-&gt;member2 = &amp;print_hello;</span><br><span class="line">    <span class="comment">/* call the function pointer */</span></span><br><span class="line">    ms-&gt;member2(<span class="number">12</span>);</span><br><span class="line">    <span class="built_in">free</span>(ms);</span><br><span class="line">    <span class="keyword">char</span> *buffer = <span class="built_in">malloc</span>(<span class="number">16</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(buffer, argv[<span class="number">1</span>], <span class="number">16</span>);</span><br><span class="line">    ms-&gt;member2(<span class="number">12</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<img src="https://olivierpierre.github.io/comp26020/slides/26-memory-safety/include/use-after-free-1.svg" alt="use after free 1"><br><img src="https://olivierpierre.github.io/comp26020/slides/26-memory-safety/include/use-after-free-2.svg" alt="use after free 2"><br><img src="https://olivierpierre.github.io/comp26020/slides/26-memory-safety/include/use-after-free-3.svg" alt="use after free 3"><br><img src="https://olivierpierre.github.io/comp26020/slides/26-memory-safety/include/use-after-free-4.svg" alt="use after free 4"></li>
</ol>
<ul>
<li>Because I can control what to input in command line, can overwrite the function pointer with the address of security<h1 id="Good-Practices"><a href="#Good-Practices" class="headerlink" title="Good Practices"></a>Good Practices</h1><h2 id="Writing-Good-Code"><a href="#Writing-Good-Code" class="headerlink" title="Writing Good Code"></a>Writing Good Code</h2></li>
<li>The compiler won’t catch all mistakes</li>
<li>The tools have their limitations</li>
<li>Writing good code from the start is super important<ul>
<li>It will save you a lot of debugging time</li>
<li>It will save you from introducing serious security issues</li>
</ul>
</li>
<li>Never use these functions, always unsafe:<ul>
<li>gets (use fgets)</li>
<li>getwd (use getcwd)</li>
<li>readdir_r (use readdir)</li>
<li>More here: <a target="_blank" rel="noopener" href="https://bit.ly/3ef4TBc">https://bit.ly/3ef4TBc</a><h2 id="String-Manipulation-Functions"><a href="#String-Manipulation-Functions" class="headerlink" title="String Manipulation Functions"></a>String Manipulation Functions</h2></li>
</ul>
</li>
<li>Use the n methods,<ul>
<li>strcpy -&gt; strncpy</li>
<li>sprintf -&gt; snprintf</li>
</ul>
</li>
<li>Even with the versions with n, some specificities<ul>
<li>strncpy won’t add \0 at the end of the target buffer<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> string1[] = <span class="string">&quot;hello, world&quot;</span>;</span><br><span class="line"><span class="keyword">char</span> string2[<span class="number">32</span>] = <span class="string">&quot;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&quot;</span>;</span><br><span class="line"><span class="built_in">strncpy</span>(string2, string1, <span class="built_in">strlen</span>(string1));</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, string2); <span class="comment">// prints &quot;hello, worldxxxxxxxxxxxxxxxxxxx&quot;</span></span><br></pre></td></tr></table></figure>
<h2 id="Dynamic-Memory-Allocation-1"><a href="#Dynamic-Memory-Allocation-1" class="headerlink" title="Dynamic Memory Allocation"></a>Dynamic Memory Allocation</h2></li>
</ul>
</li>
<li>Check malloc return value</li>
<li>After free, the pointer is invalid<ul>
<li>Cannot be dereferenced</li>
<li>Cannot be used (ex: comparison)</li>
</ul>
</li>
<li>realloc returns null upon failure but does not free the old pointer<ul>
<li>so this: ptr = realloc(ptr, new_size) is a leak</li>
</ul>
</li>
</ul>
<h1 id="Quiz-review"><a href="#Quiz-review" class="headerlink" title="Quiz review"></a>Quiz review</h1><h2 id="Quiz-2"><a href="#Quiz-2" class="headerlink" title="Quiz 2"></a>Quiz 2</h2><ul>
<li>Int is 4 bytes, short is 2 bytes, float is 4 bytes, double is 8 bytes, char is 1 bytes, unsigned long int is 8 bytes.</li>
<li>The compiler, parsing the sources from top to bottom, wants to have either the full implementation or at least a forward declaration of negate_int before a first call to that function is encoutered.<h2 id="Quiz-3"><a href="#Quiz-3" class="headerlink" title="Quiz 3"></a>Quiz 3</h2></li>
<li>strcmp returns 0 when the strings match</li>
<li>11 in base 10 corresponds to 0xB In hexadecimal.</li>
<li>struct members are placed in order contiguously in memory, the address of the first member of the struct is the same as the address of the struct itself, so the address of the second member is 0x7ffd04d39a48 + 4 bytes (the size of the 1st member) = 0x7ffd04d39a4c</li>
<li>Pointers are useful to allow a function to modify its calling context and to avoid passing large parameters as copy. </li>
<li>y is a local variable and it is thus located on the stack. x being a global variable, it is located in static memory.</li>
<li>We use O_RDWR to indicate read and write mode, O_TRUNC to destroy the file content if it exists, and O_CREAT to create the file if it does not exist<h2 id="Quiz-4"><a href="#Quiz-4" class="headerlink" title="Quiz 4"></a>Quiz 4</h2></li>
<li>For a parent function C1 with <code>virtual int function</code>:<ul>
<li> it cannot be instantiated </li>
<li> all classes inheriting from C1 need to provide an implementation for function(</li>
</ul>
</li>
<li>The vector needs to be declared with the containing type between <code>&lt; &gt;</code>. An empty vector can be filled with <code>push_back()</code>. The vector constructor also takes an optional parameter that initializes empty elements, allowing them to be updated with<code>[ ]</code>without prior calls to push_back(). </li>
<li> strcpy should be used rather than = to ensure a copy of the string itself and not a simple copy of the pointer used to refer to the character array</li>
<li>Dynamic object allocation is made with new, that returns a pointer to an object and not the object itself<ul>
<li> <code>Library *l = new Library(100);</code></li>
</ul>
</li>
<li>Overloading corresponds to compile-time polymorphism, while overriding regards runtime polymorphism</li>
<li>Constructor’s implementation with same name <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">C</span> &#123;</span></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        <span class="keyword">int</span> member;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        C(<span class="keyword">int</span> member);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    C::C(<span class="keyword">int</span> member) &#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;member = member;</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure></li>
<li>Call the parent constructor:  following a colon placed right after the child’s constructor parameter <code>list. _a </code> cannot be accessed directly in the child’s constructor (or in any of the child member functions) because it is private in Parent.<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Child::Child(<span class="keyword">int</span> a, <span class="keyword">int</span> b) : Parent(a) &#123;</span><br><span class="line">    _b = b;</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>
<h2 id="Quiz-5"><a href="#Quiz-5" class="headerlink" title="Quiz 5"></a>Quiz 5</h2></li>
<li>By convention, up to 6 arguments for system calls are passed in order in %rdi, %rsi, %rdx, %r10, %r8, and %r9<ul>
<li>By convention, on x86-64 the return value of a system call is placed in %rax</li>
</ul>
</li>
<li>During the execution of printf, Musl uses <code>writev</code> to write to the file descriptor corresponding to the standard output under the hood by the Musl C library</li>
<li>The preprocessor is used for including headers, expanding macros, and enabling/disabling bits of code conditionally.</li>
<li>The int gets promoted to a double and the result of the addition is then a double, which gets interpreted as an int due to the %d specifier, printing garbage.<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">12</span>;</span><br><span class="line">    <span class="keyword">double</span> d = <span class="number">4.6</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, i + d);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure></li>
<li>Access latency rank: registers are the fastest, followed by the cache, followed by main memory, then we have the disk.</li>
<li>interpreted as an unsigned int (4 bytes), the long long unsigned int (8 bytes) gets its <em>higher 4 bytes truncated截断</em>.<ul>
<li>E.g: <code>long long unsigned int  x = 0x400000000001;</code> turn to unsigned int will become <code>1</code></li>
</ul>
</li>
<li>The addition overflow the 4 bytes reserved for an int, and the variable wraps over to the <em>smallest</em> value that can be stored in an int: -2147483648<ul>
<li>int i = 2147483647 + 1</li>
<li>2147483647 is the max positive value that can be stored in an int</li>
</ul>
</li>
<li>The addition of 1 triggers an overflow of the unsigned int type that is stored on 4 bytes, an as it is <em>unsigned</em> it wraps over to 0.<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> ui = <span class="number">4294967295</span>; <span class="comment">// this is 32 bits full of 1&#x27;s</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%u\n&quot;</span>, ui+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure></li>
<li>Illustrate preprocessor:<ul>
<li>The preprocessor produces source files as output</li>
<li>The preprocessor performs textual transformations on C sources</li>
<li>The preprocessor is generally called under the hood by the compiler</li>
<li>During the program build process, the preprocessor pass is made before the compilation (transformation of sources into machine code) pass</li>
<li>The preprocessor takes source files as input</li>
</ul>
</li>
<li> Include guards allow to avoid the issue that the compiler encountering the definition of the struct twice while there should be only a single definition per struct over the entire program.</li>
<li> C/C++ are fast because they integrated well with assembly, and have no runtime overheads due to things such as the lack of memory access checks or garbage collection. They also give the programmer a high degree of control over the program memory layout, which helps for various things such as fitting as much data/code as possible in the CPU cache.<h2 id="Quiz-6"><a href="#Quiz-6" class="headerlink" title="Quiz 6"></a>Quiz 6</h2></li>
<li>Use-after-free bugs are generally not detected by the compiler, they put the program into undefined behavior and can allow an attacker to subvert its control flow. They do not necessarily lead to a crash at runtime.</li>
<li>the mechanism(s) used to save the user context of a task during a syscall, and to save the kernel context of a task during a context switch by <em>Pushing the CPU registers’ content on the stack</em></li>
<li>Mistakes that corresponds to memory errors<ul>
<li>Reading an uninitialized variable on the stack</li>
<li>Double free of a pointer</li>
<li>Reading the content of an uninitialized buffer on the heap</li>
<li>Use-after-free</li>
<li>Out-of bound array/buffer access </li>
<li>Dereferencing a NULL pointer</li>
</ul>
</li>
<li>System call handling and context switching in an OS are generally implemented<ul>
<li>with a mix of C and assembly</li>
<li>with memory unsafe languages<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">f</span><span class="params">(<span class="keyword">char</span> *user_buf)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">char</span> local[<span class="number">128</span>];</span><br><span class="line">      <span class="built_in">strcpy</span>(local, user_buf);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;you entered: %s\n&quot;</span>, user_buf);</span><br><span class="line">      <span class="comment">/* ... */</span></span><br><span class="line">&#125;    </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span>(argc != <span class="number">2</span>) &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line">      f(argv[<span class="number">1</span>]);</span><br><span class="line">      <span class="comment">/* ... */</span></span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>The possibility to overflow in write mode a local buffer with strcpy can lead to a stack smashing attack.</li>
</ul>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        Share
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=http://example.com/2022/04/21/Programming-Languages-and-Paradigms-Part-1/" alt="微信分享二维码">
    </div>
</div>

<div id="share-mask"></div>  
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/26020-Programming-Languages-and-Paradigms/" rel="tag">26020 Programming Languages and Paradigms</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/C/" rel="tag">C</a></li></ul>

    </footer>
  </div>

   
  <nav class="article-nav">
    
      <a href="/2022/05/07/Distributed-System/" class="article-nav-link">
        <strong class="article-nav-caption">Last Article</strong>
        <div class="article-nav-title">
          
            Distributed System
          
        </div>
      </a>
    
    
      <a href="/2021/09/03/%E7%AE%97%E6%B3%95%EF%BC%9A%E6%A0%88%E3%80%81%E9%98%9F%E5%88%97%E3%80%81%E9%93%BE%E8%A1%A8/" class="article-nav-link">
        <strong class="article-nav-caption">Next Article</strong>
        <div class="article-nav-title">算法：栈、队列、链表</div>
      </a>
    
  </nav>

  
   
  
    
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2020-2023
        <i class="ri-heart-fill heart_icon"></i> Yangyang Cui
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.svg" alt="Yangyang"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">Home</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">archives</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">categories</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">tags</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-3.6.0.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->
 
<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: ".tocbot",
    contentSelector: ".article-entry",
    headingSelector: "h1, h2, h3, h4, h5, h6",
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: "main",
    positionFixedSelector: ".tocbot",
    positionFixedClass: "is-position-fixed",
    fixedSidebarOffset: "auto",
  });
</script>

<script src="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.css"
/>
<script src="https://cdn.staticfile.org/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/default-skin/default-skin.min.css">
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script> 
<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->

<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="https://cdn.staticfile.org/clipboard.js/2.0.10/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>
 
<!-- CanvasBackground -->

<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "forest" });
  }
</script>


    
    

  </div>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/assets/tororo.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":0.7},"log":false});</script></body>

</html>